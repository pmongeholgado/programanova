<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Generador de Presentaciones Â· Nova</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #0c0f17;
                color: #e5e7eb;
                margin: 0;
                padding: 24px;
            }

            h1 {
                text-align: center;
                color: #5ddcff;
            }

            .box {
                max-width: 640px;
                margin: auto;
                background: rgba(255,255,255,0.04);
                border: 1px solid rgba(255,255,255,0.1);
                padding: 24px;
                border-radius: 12px;
            }

            label {
                font-weight: bold;
            }

            input, textarea, select {
                width: 100%;
                padding: 12px;
                margin-top: 8px;
                margin-bottom: 16px;
                border-radius: 8px;
                border: none;
            }

            button {
                width: 100%;
                padding: 14px;
                background: linear-gradient(90deg, #1e90ff, #00c2ff);
                border: none;
                border-radius: 8px;
                color: white;
                font-size: 18px;
                cursor: pointer;
            }

            button:hover {
                background: linear-gradient(90deg, #00c2ff, #1e90ff);
            }

            .estado {
                text-align: center;
                margin-top: 20px;
                color: #7dd3fc;
                font-weight: bold;
            }

        #resultado {
            margin-top: 24px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 16px;
            border-radius: 10px;
        }

        #resultado h3 {
            color: #5ddcff;
            margin-bottom: 12px;
            text-align: center;
        }

        #resultado ul {
            padding-left: 20px;
        }

        #resultado li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
    </style>
</head>

<body>

<h1>Generador Nova Â· Presentaciones</h1>

<div class="box">
    <label>TÃ­tulo de la presentaciÃ³n</label>
    <input type="text" id="titulo" placeholder="Ejemplo: InnovaciÃ³n y futuro de la colaboraciÃ³n humano-IA" />

    <label>NÃºmero de diapositivas</label>
    <select id="slides">
        <option value="10">10 diapositivas</option>
        <option value="12">12 diapositivas</option>
        <option value="15">15 diapositivas</option>
        <option value="20">20 diapositivas</option>
    </select>

    <label>Contenido base (capÃ­tulo, texto o guion)</label>
    <textarea id="contenido" rows="6" placeholder="Pega aquÃ­ tu capÃ­tulo, texto o guion baseâ€¦"></textarea>

    <button onclick="generar()">Generar estructura de presentaciÃ³n</button>
    <button id="btnPPT" onclick="exportarPPT()" disabled>ðŸ“¤ Exportar a PPT</button>
    <button id="btnPPT2" onclick="exportarPPT()" disabled>ðŸ“Š Exportar a PowerPoint</button>
    
    <div class="estado" id="estado">ðŸŸ¢ Generador listo</div>
    <div id="resultado" style="margin-top:20px;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    
<script>
let estructuraGenerada = [];
let ultimaEstructuraLimpia = []; // lo que realmente exportaremos

const API_BASE_URL = "https://programanovabackend-production.up.railway.app";

/** Limpia markdown, numeraciÃ³n y separa tÃ­tulo + bullets */
function normalizarItem(item) {
  let s = String(item || "").trim();

  // Quitar markdown fuerte **texto**
  s = s.replace(/\*\*/g, "");

  // Quitar numeraciÃ³n tipo "1. " al inicio
  s = s.replace(/^\s*\d+\.\s*/, "");

  // Quitar guiones repetidos tipo "- "
  s = s.replace(/^\s*-\s*/gm, "");

  // Si contiene " - Idea principal:" lo separamos
  let titulo = s;
  let bullets = [];

  const parts = s.split(/\s*-\s*Idea principal:\s*/i);
  if (parts.length > 1) {
    titulo = parts[0].trim();
    const idea = parts.slice(1).join(" - Idea principal: ").trim();
    if (idea) bullets.push(idea);
  }

  // Si el tÃ­tulo aÃºn trae ":" tipo "Portada: ..." separamos
  const colon = titulo.split(/\s*:\s*/);
  if (colon.length > 1) {
    titulo = colon[0].trim();
    const resto = colon.slice(1).join(": ").trim();
    if (resto) bullets.push(resto);
  }

  // Si hay lÃ­neas mÃºltiples, primera = tÃ­tulo y el resto bullets
  const lines = titulo.split("\n").map(l => l.trim()).filter(Boolean);
  if (lines.length > 1) {
    titulo = lines[0];
    bullets = bullets.concat(lines.slice(1));
  }

  // Quitar frases no deseadas si vienen mezcladas
  const basura = [
    "AquÃ­ tienes la estructura de la presentaciÃ³n",
    "Estructura generada",
    "PresentaciÃ³n generada correctamente"
  ];
  if (basura.some(b => titulo.toLowerCase().includes(b.toLowerCase()))) {
    // Si detectamos basura, intentamos quedarnos con algo Ãºtil
    // (si no hay, devolvemos vacÃ­o)
    titulo = titulo.replace(/AquÃ­ tienes.*?:/i, "").trim();
  }

  return { titulo: titulo.trim(), bullets: bullets.map(b => b.trim()).filter(Boolean) };
}

/** Construye estructura limpia (array de {titulo, bullets}) */
function construirEstructuraLimpia(arr) {
  const out = [];
  for (const it of (arr || [])) {
    const obj = normalizarItem(it);
    if (!obj.titulo) continue;
    out.push(obj);
  }
  return out;
}

async function generar() {
  const tituloEl = document.getElementById("titulo");
  const slidesEl = document.getElementById("slides");
  const contenidoEl = document.getElementById("contenido");
  const estadoEl = document.getElementById("estado");
  const resultadoEl = document.getElementById("resultado");

  const titulo = (tituloEl.value || "").trim();
  const numDiapositivas = slidesEl.value;
  const contenido = (contenidoEl.value || "").trim();

  if (!contenido) {
    estadoEl.innerText = "âš ï¸ Introduce un texto base antes de generar la presentaciÃ³n.";
    return;
  }

  estadoEl.innerText = "â³ Procesando solicitudâ€¦";
  resultadoEl.innerHTML = "";

  try {
    const response = await fetch(`${API_BASE_URL}/generar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ titulo, num_diapositivas: numDiapositivas, contenido }),
      mode: "cors",
    });

    if (!response.ok) {
      estadoEl.innerText = "âŒ Error al procesar la solicitud.";
      return;
    }

    const data = await response.json().catch(() => ({}));

    estadoEl.innerText = data.mensaje || "âœ… Estructura generada correctamente.";

    if (Array.isArray(data.estructura)) {
      estructuraGenerada = data.estructura;
      ultimaEstructuraLimpia = construirEstructuraLimpia(data.estructura);

      // Habilitar ambos botones de exportaciÃ³n
      document.getElementById("btnPPT").disabled = false;
      document.getElementById("btnPPT2").disabled = false;

      // Mostrar la versiÃ³n "limpia" en pantalla (mÃ¡s bonita)
      resultadoEl.innerHTML = `
        <h3>Estructura generada</h3>
        <ul>
          ${ultimaEstructuraLimpia.map((obj, i) => {
            const bullets = obj.bullets.length
              ? `<ul>${obj.bullets.map(b => `<li>${b}</li>`).join("")}</ul>`
              : "";
            return `<li><b>${i+1}. ${obj.titulo}</b>${bullets}</li>`;
          }).join("")}
        </ul>
      `;
    } else {
      estadoEl.innerText = "âš ï¸ No se recibiÃ³ una estructura vÃ¡lida.";
    }

  } catch (err) {
    estadoEl.innerText = "âŒ No se pudo conectar con el servicio.";
  }
}

function exportarPPT() {
  if (!ultimaEstructuraLimpia.length) {
    alert("Primero genera una presentaciÃ³n.");
    return;
  }

  const titulo = (document.getElementById("titulo").value || "Nova_Presentacion").trim();
  const safeTitle = titulo.replace(/[^\w\-]+/g, "_").slice(0, 40);
  const fileName = `${safeTitle || "Nova_Presentacion"}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.pptx`;

  const pptx = new PptxGenJS();

  ultimaEstructuraLimpia.forEach((obj, index) => {
    const slide = pptx.addSlide();

    // TÃ­tulo diapositiva
    slide.addText(`${index + 1}. ${obj.titulo}`, {
      x: 0.5, y: 0.5, w: 9, h: 0.8,
      fontSize: 22, bold: true
    });

    // Bullets (si existen)
    if (obj.bullets.length) {
      slide.addText(obj.bullets.map(b => `â€¢ ${b}`).join("\n"), {
        x: 0.7, y: 1.5, w: 9, h: 4.5,
        fontSize: 16, wrap: true
      });
    } else {
      // Si no hay bullets, metemos una lÃ­nea limpia
      slide.addText("â€¢ Idea principal: (sin detalle adicional)", {
        x: 0.7, y: 1.5, w: 9, h: 1.0,
        fontSize: 16, wrap: true
      });
    }
  });
    
  const fileName = `${titulo || "Nova_Presentacion"}.pptx`;
  pptx.writeFile({ fileName });
}
    
</script>

</body>
</html>
