<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Generador de Presentaciones Â· Nova</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #0c0f17;
                color: #e5e7eb;
                margin: 0;
                padding: 24px;
            }

            h1 {
                text-align: center;
                color: #5ddcff;
            }

            .box {
                max-width: 640px;
                margin: auto;
                background: rgba(255,255,255,0.04);
                border: 1px solid rgba(255,255,255,0.1);
                padding: 24px;
                border-radius: 12px;
            }

            label {
                font-weight: bold;
            }

            input, textarea, select {
                width: 100%;
                padding: 12px;
                margin-top: 8px;
                margin-bottom: 16px;
                border-radius: 8px;
                border: none;
            }

            button {
                width: 100%;
                padding: 14px;
                background: linear-gradient(90deg, #1e90ff, #00c2ff);
                border: none;
                border-radius: 8px;
                color: white;
                font-size: 18px;
                cursor: pointer;
            }

            button:hover {
                background: linear-gradient(90deg, #00c2ff, #1e90ff);
            }

            .estado {
                text-align: center;
                margin-top: 20px;
                color: #7dd3fc;
                font-weight: bold;
            }

        #resultado {
            margin-top: 24px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 16px;
            border-radius: 10px;
        }

        #resultado h3 {
            color: #5ddcff;
            margin-bottom: 12px;
            text-align: center;
        }

        #resultado ul {
            padding-left: 20px;
        }

        #resultado li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
    </style>
</head>

<body>

<h1>Generador Nova Â· Presentaciones</h1>

<div style="text-align:center; margin-bottom:16px;">
    <select id="langSelector" onchange="setLanguage(this.value)">
        <option value="es">EspaÃ±ol</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èªž</option>
    </select>
</div>
    
<div class="box">
    <label for="titulo">TÃ­tulo de la presentaciÃ³n</label>
    <input type="text" id="titulo" placeholder="Ejemplo: InnovaciÃ³n y futuro de la colaboraciÃ³n humano-IA" />

    <label for="slides">NÃºmero de diapositivas</label>
    <select id="slides">
        <option value="10">10 diapositivas</option>
        <option value="12">12 diapositivas</option>
        <option value="15">15 diapositivas</option>
        <option value="20">20 diapositivas</option>
    </select>

    <label for="contenido">Contenido base (capÃ­tulo, texto o guion)</label>
    <textarea id="contenido" rows="6" placeholder="Pega aquÃ­ tu capÃ­tulo, texto o guion baseâ€¦"></textarea>

    <button onclick="generar()">Generar estructura de presentaciÃ³n</button>
    <button id="btnPPT" onclick="exportarPPT()" disabled>ðŸ“¤ Exportar a PPT</button>
    <button id="btnPPT2" onclick="exportarPPT()" disabled>ðŸ“Š Exportar a PowerPoint</button>
    
    <div class="estado" id="estado">ðŸŸ¢ Generador listo</div>
    <div id="resultado" style="margin-top:20px;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    
<script>
    let estructuraGenerada = [];
    let ultimaEstructuraLimpia = []; 
    let currentLang = "es";

    const textos = {
      es: {
        titulo: "Generador Nova Â· Presentaciones",
        labelTitulo: "TÃ­tulo de la presentaciÃ³n",
        labelSlides: "NÃºmero de diapositivas",
        labelContenido: "Contenido base (capÃ­tulo, texto o guion)",
        btnGenerar: "Generar estructura de presentaciÃ³n",
        btnPPT: "ðŸ“¤ Exportar a PPT",
        estadoListo: "ðŸŸ¢ Generador listo",
        estadoProcesando: "â³ Procesando solicitudâ€¦",
        errorContenido: "âš ï¸ Introduce un texto base antes de generar la presentaciÃ³n.",
        errorConexion: "âŒ No se pudo conectar con el servicio.",
        phTitulo: "Ejemplo: InnovaciÃ³n y futuro de la colaboraciÃ³n humano-IA",
        phContenido: "Pega aquÃ­ tu capÃ­tulo, texto o guion baseâ€¦"
      },

      en: {
        titulo: "Nova Presentation Generator",
        labelTitulo: "Presentation title",
        labelSlides: "Number of slides",
        labelContenido: "Base content (chapter, text or script)",
        btnGenerar: "Generate presentation structure",
        btnPPT: "ðŸ“¤ Export to PPT",
        estadoListo: "ðŸŸ¢ Generator ready",
        estadoProcesando: "â³ Processing requestâ€¦",
        errorContenido: "âš ï¸ Please enter base content before generating.",
        errorConexion: "âŒ Could not connect to the service.",
        phTitulo: "Example: Innovation and the future of human-AI collaboration",
        phContenido: "Paste your chapter, text, or script hereâ€¦"
      },

      ja: {
        titulo: "Nova ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆå™¨",
        labelTitulo: "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«",
        labelSlides: "ã‚¹ãƒ©ã‚¤ãƒ‰æ•°",
        labelContenido: "ãƒ™ãƒ¼ã‚¹å†…å®¹ï¼ˆç« ãƒ»ãƒ†ã‚­ã‚¹ãƒˆãƒ»å°æœ¬ï¼‰",
        btnGenerar: "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆã‚’ç”Ÿæˆ",
        btnPPT: "ðŸ“¤ PPTã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
        estadoListo: "ðŸŸ¢ æº–å‚™å®Œäº†",
        estadoProcesando: "â³ å‡¦ç†ä¸­â€¦",
        errorContenido: "âš ï¸ ç”Ÿæˆã™ã‚‹å‰ã«å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
        errorConexion: "âŒ ã‚µãƒ¼ãƒ“ã‚¹ã«æŽ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚",
        phTitulo: "ä¾‹ï¼šäººé–“ã¨AIã®å”åƒã®é©æ–°ã¨æœªæ¥",
        phContenido: "ã“ã“ã«ç« ãƒ»æœ¬æ–‡ãƒ»å°æœ¬ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„â€¦"
      }
    };
   
function setLanguage(lang) { 
    const t = textos[lang] || textos.es;

    currentLang = lang;
    localStorage.setItem("nova_lang", lang);

    document.querySelector("h1").innerText = t.titulo;

    document.querySelector("label[for='titulo']").innerText = t.labelTitulo;
    document.querySelector("label[for='slides']").innerText = t.labelSlides;
    document.querySelector("label[for='contenido']").innerText = t.labelContenido;

    document.getElementById("titulo").placeholder = t.phTitulo;
    document.getElementById("contenido").placeholder = t.phContenido;

    document.querySelector("button[onclick='generar()']").innerText = t.btnGenerar;
    document.getElementById("btnPPT").innerText = t.btnPPT;

    document.getElementById("estado").innerText = t.estadoListo;
    }
    
    const API_BASE_URL = "https://programanovabackend-production.up.railway.app";
    // ðŸ”¹ InicializaciÃ³n final del idioma (ÃšNICA)
    const savedLang = localStorage.getItem("nova_lang") || "es";
    document.getElementById("langSelector").value = savedLang;    
    setLanguage(savedLang);
    /** Limpia markdown, numeraciÃ³n y separa tÃ­tulo + bullets */
      function normalizarItem(item) {
        let s = String(item || "").trim();

      // Quitar markdown fuerte **texto**
      s = s.replace(/\*\*/g, "");

      // Quitar numeraciÃ³n tipo "1." 
      s = s.replace(/^\s*\d+\.\s*/, "");
    
      // Quitar guiones repetidos tipo "- "
      s = s.replace(/^\s*-\s*/gm, "");

      // Si contiene " - Idea principal:" lo separamos
      let titulo = s;
      let bullets = [];

    const parts = s.split(/\s*-\s*Idea principal:\s*/i);
      if (parts.length > 1) {
          titulo = parts[0].trim();
    const idea = parts.slice(1).join(" - Idea principal: ").trim();
      if (idea) bullets.push(idea);
      }

  // Si el tÃ­tulo aÃºn trae ":" tipo "Portada: ..." separamos
  const colon = titulo.split(/\s*:\s*/);
      if (colon.length > 1) {
          titulo = colon[0].trim();
  const resto = colon.slice(1).join(": ").trim();
      if (resto) bullets.push(resto);
      }

  // Si hay lÃ­neas mÃºltiples, primera = tÃ­tulo y el resto bullets
  const lines = titulo.split("\n").map(l => l.trim()).filter(Boolean);
  if (lines.length > 1) {
    titulo = lines[0];
    bullets = bullets.concat(lines.slice(1));
  }

  // Quitar frases no deseadas si vienen mezcladas
  const basura = [
    "AquÃ­ tienes la estructura de la presentaciÃ³n",
    "Estructura generada",
    "PresentaciÃ³n generada correctamente"
  ];
  if (basura.some(b => titulo.toLowerCase().includes(b.toLowerCase()))) {
    // Si detectamos basura, intentamos quedarnos con algo Ãºtil
    // (si no hay, devolvemos vacÃ­o)
    titulo = titulo.replace(/AquÃ­ tienes.*?:/i, "").trim();
  }

  return { titulo: titulo.trim(), bullets: bullets.map(b => b.trim()).filter(Boolean) };
}

/** Construye estructura limpia (array de {titulo, bullets}) */
function construirEstructuraLimpia(arr) {
  const out = [];
  for (const it of (arr || [])) {
    const obj = normalizarItem(it);
    if (!obj.titulo) continue;
    out.push(obj);
  }
  return out;
}

async function generar() {
  const tituloEl = document.getElementById("titulo");
  const slidesEl = document.getElementById("slides");
  const contenidoEl = document.getElementById("contenido");
  const estadoEl = document.getElementById("estado");
  const resultadoEl = document.getElementById("resultado");

  const t = textos[currentLang] || textos.es;

  const titulo = (tituloEl.value || "").trim();
  const numDiapositivas = slidesEl.value;
  const contenido = (contenidoEl.value || "").trim();

  if (!contenido) {
    estadoEl.innerText = t.errorContenido;
    return;
  }

  estadoEl.innerText = t.estadoProcesando;
  resultadoEl.innerHTML = "";

  try {
    const response = await fetch(`${API_BASE_URL}/generar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ titulo, num_diapositivas: numDiapositivas, contenido }),
      mode: "cors",
    });

    if (!response.ok) {
      estadoEl.innerText = t.errorConexion;
      return;
    }

    const data = await response.json().catch(() => ({}));
    estadoEl.innerText = data.mensaje || "âœ… Estructura generada correctamente.";

    if (Array.isArray(data.estructura)) {
      estructuraGenerada = data.estructura;
      ultimaEstructuraLimpia = construirEstructuraLimpia(data.estructura);

      document.getElementById("btnPPT").disabled = false;
      document.getElementById("btnPPT2").disabled = false;

      resultadoEl.innerHTML = `
        <h3>Estructura generada</h3>
        <ul>
          ${ultimaEstructuraLimpia.map((obj, i) => {
            const bullets = obj.bullets.length
              ? `<ul>${obj.bullets.map(b => `<li>${b}</li>`).join("")}</ul>`
              : "";
            return `<li><b>${i + 1}. ${obj.titulo}</b>${bullets}</li>`;
          }).join("")}
        </ul>
      `;
    }
  } catch (err) {
    estadoEl.innerText = t.errorConexion;
  }
}    
        
function exportarPPT() {
if (siguiente?.bullets?.length) {
    slide.addText(
        siguiente.bullets.map(b => `- ${b}`).join("\n"),
        {
          x: 0.7,
          y: 1.5,
          w: 9,
          h: 4.5,
          fontSize: 16,
          wrap: true,
        }
      );
    }

  const titulo = (document.getElementById("titulo").value || "Nova_Presentacion").trim();
  const safeTitle = titulo.replace(/[^\w\-]+/g, "_").slice(0, 40);
  const fileName = `${safeTitle || "Nova_Presentacion"}_${new Date()
    .toISOString()
    .slice(0, 19)
    .replace(/[:T]/g, "-")}.pptx`;

  const pptx = new PptxGenJS();

  ultimaEstructuraLimpia.forEach((obj, index) => {
    const slide = pptx.addSlide();

    // TÃ­tulo de la diapositiva
    slide.addText(`${index + 1}. ${obj.titulo}`, {
      x: 0.5,
      y: 0.5,
      w: 9,
      h: 0.8,
      fontSize: 22,
      bold: true,
    });

    // Bullets (si existen)
    if (obj.bullets.length) {
      slide.addText(obj.bullets.map(b => `â€¢ ${b}`).join("\n"), {
        x: 0.7, y: 1.5, w: 9, h: 4.5,
        fontSize: 16, wrap: true
      });
      slide.addText("â€¢ Idea principal: (sin detalle adicional)", {
        x: 0.7,
        y: 1.5,
        w: 9,
        h: 4.5,
        fontSize: 16,
        wrap: true,
      });
    } else {
      slide.addText("â€¢ Idea principal", {
        x: 0.7,
        y: 1.5,
        w: 9,
        h: 1.0,
        fontSize: 16,
        wrap: true,
      });
    }
  }); 

  // Export correcto
  pptx.writeFile({ fileName });
}    
</script>
</body>
</html>
