<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generador de Presentaciones ¬∑ Nova</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0c0f17;
      color: #e5e7eb;
      margin: 0;
      padding: 24px;
    }

    h1 {
      text-align: center;
      color: #5ddcff;
      margin-bottom: 22px;
      letter-spacing: 0.4px;
    }

    .box {
      max-width: 820px;
      margin: auto;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 24px;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
      color: #cbd5e1;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin-top: 4px;
      margin-bottom: 16px;
      border-radius: 10px;
      border: none;
      outline: none;
      background: rgba(255,255,255,0.08);
      color: #e5e7eb;
      font-size: 15px;
    }

    textarea {
      resize: vertical;
      min-height: 140px;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(90deg, #1e90ff, #00c2ff);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 18px;
      cursor: pointer;
      margin-bottom: 10px;
      font-weight: bold;
    }

    button:hover {
      opacity: 0.95;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .estado {
      text-align: center;
      margin-top: 12px;
      color: #7dd3fc;
      font-weight: bold;
      font-size: 15px;
    }

    .mini {
      text-align: center;
      font-size: 13px;
      color: #94a3b8;
      margin-top: -6px;
      margin-bottom: 12px;
    }

    #resultado {
      margin-top: 18px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 16px;
      border-radius: 12px;
    }

    #resultado h3 {
      color: #5ddcff;
      margin-bottom: 12px;
      text-align: center;
    }

    #resultado ul {
      padding-left: 22px;
    }

    #resultado li {
      margin-bottom: 8px;
      line-height: 1.35;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    @media (max-width: 900px) {
      .row { grid-template-columns: 1fr; }
    }

    #loader {
      display: none;
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
      color: #a5b4fc;
    }

    hr {
      border: none;
      height: 1px;
      background: rgba(148,163,184,0.22);
      margin: 18px 0;
    }
  </style>
</head>

<body>
  <h1>Generador Nova ¬∑ Presentaciones <span style="font-size:14px; color:#7dd3fc;">PRO</span></h1>

  <div class="box">

    <div class="row">
      <div>
        <label for="langSelector">Idioma</label>
        <select id="langSelector" onchange="setLanguage(this.value)">
          <option value="es">Espa√±ol</option>
          <option value="en">English</option>
          <option value="ja">Êó•Êú¨Ë™û</option>
        </select>
      </div>

      <div>
        <label for="motorIA">Motor IA (PRO)</label>
        <select id="motorIA" onchange="setMotorIA(this.value)">
          <!-- opciones por JS -->
        </select>
        <div class="mini" id="estadoMotor">üß† Motor IA: NOVA (Backend actual)</div>
      </div>
    </div>

    <label for="titulo">T√≠tulo de la presentaci√≥n</label>
    <input type="text" id="titulo" placeholder="Ejemplo: Innovaci√≥n y futuro de la colaboraci√≥n humano-IA" />

    <label for="slides">N√∫mero de diapositivas</label>
    <select id="slides">
      <option value="10">10 diapositivas</option>
      <option value="12">12 diapositivas</option>
      <option value="15">15 diapositivas</option>
      <option value="20">20 diapositivas</option>
    </select>

    <label for="contenido">Contenido base (cap√≠tulo, texto o guion)</label>
    <textarea id="contenido" rows="6" placeholder="Pega aqu√≠ tu cap√≠tulo, texto o guion base‚Ä¶"></textarea>

    <button id="btnGenerar" onclick="generar()">Generar estructura de presentaci√≥n</button>

    <div id="loader">‚è≥ Procesando‚Ä¶</div>
    <div class="estado" id="estado">üü¢ Generador listo</div>

    <hr />

    <button id="btnPPT" disabled>üì§ Exportar a PPT</button>
    <button id="btnPPT2" disabled>üìä Exportar a PowerPoint</button>

    <div id="resultado"></div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

  <script>
    window.EXPORTANDO_PPT = false;

    // =========================
    // VARIABLES GLOBALES
    // =========================
    let estructuraGenerada = [];
    let ultimaEstructuraLimpia = [];
    let PRESENTACION_PRO = null;
    
    // FASE 2 PRO
    let planPro = [];

    // =========================
    // CONFIG BACKEND
    // =========================
    const API_BASE_URL = "https://programanovabackend-production-a426.up.railway.app";

    // Endpoints IA real
    const IA_ENDPOINTS = {
      imagen: "/generar-imagen"
      // grafico: "/generar-grafico"  // opcional (si tu backend lo tuviera)
    };

    // =========================
    // I18N
    // =========================
    let currentLang = "es";

    const textos = {
      es: {
        titulo: "Generador Nova ¬∑ Presentaciones",
        labelTitulo: "T√≠tulo de la presentaci√≥n",
        labelSlides: "N√∫mero de diapositivas",
        labelContenido: "Contenido base (cap√≠tulo, texto o guion)",
        btnGenerar: "Generar estructura de presentaci√≥n",
        btnPPT: "üì§ Exportar a PPT",
        estadoListo: "üü¢ Generador listo",
        estadoProcesando: "‚è≥ Procesando solicitud‚Ä¶",
        errorContenido: "‚ö†Ô∏è Introduce un texto base antes de generar la presentaci√≥n.",
        errorConexion: "‚ùå No se pudo conectar con el servicio.",
        ok: "‚úÖ Estructura generada correctamente."
      },
      en: {
        titulo: "Nova Presentation Generator",
        labelTitulo: "Presentation title",
        labelSlides: "Number of slides",
        labelContenido: "Base content (chapter, text or script)",
        btnGenerar: "Generate presentation structure",
        btnPPT: "üì§ Export to PPT",
        estadoListo: "üü¢ Generator ready",
        estadoProcesando: "‚è≥ Processing request‚Ä¶",
        errorContenido: "‚ö†Ô∏è Please enter base content before generating.",
        errorConexion: "‚ùå Could not connect to the service.",
        ok: "‚úÖ Structure generated."
      },
      ja: {
        titulo: "Nova „Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥ÁîüÊàêÂô®",
        labelTitulo: "„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„ÅÆ„Çø„Ç§„Éà„É´",
        labelSlides: "„Çπ„É©„Ç§„ÉâÊï∞",
        labelContenido: "„Éô„Éº„ÇπÂÜÖÂÆπÔºàÁ´†„Éª„ÉÜ„Ç≠„Çπ„Éà„ÉªÂè∞Êú¨Ôºâ",
        btnGenerar: "„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥ÊßãÊàê„ÇíÁîüÊàê",
        btnPPT: "üì§ PPT„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
        estadoListo: "üü¢ Ê∫ñÂÇôÂÆå‰∫Ü",
        estadoProcesando: "‚è≥ Âá¶ÁêÜ‰∏≠‚Ä¶",
        errorContenido: "‚ö†Ô∏è ÁîüÊàê„Åô„ÇãÂâç„Å´ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        errorConexion: "‚ùå „Çµ„Éº„Éì„Çπ„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
        ok: "‚úÖ ÁîüÊàêÂÆå‰∫Ü"
      }
    };

    function setLanguage(lang) {
      currentLang = lang || "es";
      localStorage.setItem("nova_lang", currentLang);

      const t = textos[currentLang] || textos.es;

      document.querySelector("h1").innerText = t.titulo + " PRO";
      document.querySelector("label[for='titulo']").innerText = t.labelTitulo;
      document.querySelector("label[for='slides']").innerText = t.labelSlides;
      document.querySelector("label[for='contenido']").innerText = t.labelContenido;

      document.getElementById("btnGenerar").innerText = t.btnGenerar;
      document.getElementById("btnPPT").innerText = t.btnPPT;

      document.getElementById("estado").innerText = t.estadoListo;
    }

    // Inicializa idioma guardado
    const savedLang = localStorage.getItem("nova_lang") || "es";
    document.getElementById("langSelector").value = savedLang;
    setLanguage(savedLang);

    // =========================
    // MOTOR IA (Selector PRO)
    // =========================
    const AI_ENGINES = [
      { id: "nova", name: "NOVA (Backend actual)" }
    ];

    let currentEngine = localStorage.getItem("nova_engine") || "nova";

    function initMotorIA() {
      const sel = document.getElementById("motorIA");
      const estado = document.getElementById("estadoMotor");
      if (!sel || !estado) return;

      sel.innerHTML = AI_ENGINES.map(e => `<option value="${e.id}">${e.name}</option>`).join("");
      sel.value = "nova";
      currentEngine = "nova";
      localStorage.setItem("nova_engine", currentEngine);
      estado.innerText = `üß† Motor IA: ${AI_ENGINES[0].name}`;
    }

    function setMotorIA(engineId) {
      currentEngine = engineId || "nova";
      localStorage.setItem("nova_engine", currentEngine);

      const estado = document.getElementById("estadoMotor");
      const name = (AI_ENGINES.find(e => e.id === currentEngine) || AI_ENGINES[0]).name;
      if (estado) estado.innerText = `üß† Motor IA: ${name}`;

      console.log("Motor IA seleccionado:", currentEngine);
    }

    initMotorIA();

    // =========================
    // HELPERS TEXTO / ESTRUCTURA
    // =========================
    function normalizarItem(item) {
      let s = String(item || "").trim();
      s = s.replace(/\*\*/g, "");
      s = s.replace(/^\s*\d+\.\s*/, "");
      s = s.replace(/^\s*-\s*/gm, "");

      let titulo = s;
      let bullets = [];

      const parts = s.split(/\s*-\s*Idea principal:\s*/i);
      if (parts.length > 1) {
        titulo = parts[0].trim();
        const idea = parts.slice(1).join(" - Idea principal: ").trim();
        if (idea) bullets.push(idea);
      }

      const colon = titulo.split(/\s*:\s*/);
      if (colon.length > 1) {
        titulo = colon[0].trim();
        const resto = colon.slice(1).join(": ").trim();
        if (resto) bullets.push(resto);
      }

      const lines = titulo.split("\n").map(l => l.trim()).filter(Boolean);
      if (lines.length > 1) {
        titulo = lines[0];
        bullets = bullets.concat(lines.slice(1));
      }

      return { title: titulo.trim(), bullets: bullets.map(b => b.trim()).filter(Boolean) };
    }

    function construirPlanPro(slides) {
      return (slides || []).map((s, i) => {
        const title = String(s.title || s.titulo || "").trim();
        const bullets = Array.isArray(s.bullets) ? s.bullets : [];

        return {
          idx: i + 1,
          title,
          bullets,
          needs: { text: true, image: false, chart: false },
          imagePrompt: "",
          imageData: "",
          chartSpec: null
        };
      });
    }

    function aplicarReglasPro(plan) {
      return (plan || []).map((slide) => {
        if (!slide) return slide;

        const idx = slide.idx || 1;

        // Im√°genes clave: 1, 6, 9, 10
        if (idx === 1 || idx === 6 || idx === 9 || idx === 10) {
          slide.needs.image = true;
        }

        // Gr√°ficos fijos: 5 y 7
        if (idx === 5) {
          slide.needs.chart = true;
          slide.chartSpec = {
            type: "bar",
            title: "Comparativa",
            labels: ["A", "B", "C"],
            values: [40, 35, 25]
          };
        }

        if (idx === 7) {
          slide.needs.chart = true;
          slide.chartSpec = {
            type: "line",
            title: "Evoluci√≥n",
            labels: ["2022", "2023", "2024"],
            values: [20, 45, 70]
          };
        }

        if (slide.needs.image) {
          slide.imagePrompt = `Imagen corporativa profesional, moderna, sin texto, sobre: ${slide.title}. Estilo limpio y alta calidad.`;
        }

        return slide;
      });
    }

    function renderPlanPro(plan) {
      const resultadoEl = document.getElementById("resultado");
      if (!resultadoEl) return;

      resultadoEl.innerHTML = `
        <h3>üß† Plan NOVA PRO</h3>
        <ul>
          ${(plan || []).map((s) => `
            <li>
              <b>Diapositiva ${s.idx}:</b> ${s.title}<br/>
              üñº Imagen: ${s.needs?.image ? "S√≠" : "No"} | üìä Gr√°fico: ${s.needs?.chart ? "S√≠" : "No"}
            </li>
          `).join("")}
        </ul>
      `;
    }

    // =========================
    // IA Imagen REAL (Backend)
    // =========================
    async function prepararAssetsIA(plan) {
      if (!Array.isArray(plan) || !plan.length) return plan;

      // ‚úÖ FIX FINAL: asegurar imageData usando imgHead si existe
      for (let k = 0; k < plan.length; k++) {
        const s = plan[k];
        if (!s) continue;

        // Si no hay imageData pero s√≠ hay imgHead ‚Üí lo copiamos
        if (!s.imageData && s.imgHead && String(s.imgHead).startsWith("data:image/")) {
          s.imageData = s.imgHead;
        }
      }

      for (let i = 0; i < plan.length; i++) {
        const s = plan[i];
        if (!s || !s.needs) continue;

        if (s.needs.image && !s.imageData) {
          try {
            const rImg = await fetch(`${API_BASE_URL}${IA_ENDPOINTS.imagen}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              mode: "cors",
              body: JSON.stringify({
                titulo: s.title,
                prompt: s.imagePrompt || `Imagen conceptual para: ${s.title}`
              })
            });

            if (rImg.ok) {
              const img = await rImg.json().catch(() => ({}));
              const dataUrl = img.dataUrl || img.dataURL || img.data_url || "";
              if (dataUrl && String(dataUrl).startsWith("data:image/")) {
                s.imageData = dataUrl;
              }
            }
          } catch (e) {
            console.warn("IA imagen fall√≥:", e);
          }
        }
      }

      return plan;
    }

    function toPptxDataUrl(input) {
      if (!input) return "";
      const s = String(input).trim();
      if (s.startsWith("data:image/")) return s;
      if (s.startsWith("image/")) return "data:" + s;
      if (s.includes("base64,") && !s.startsWith("data:")) return "data:" + s;
      if (!s.includes(",")) return "data:image/png;base64," + s;
      return "data:image/png;base64," + (s.split(",")[1] || "");
    }

    // =========================
    // GENERAR
    // =========================
    async function generar() {
      const t = textos[currentLang] || textos.es;

      const tituloEl = document.getElementById("titulo");
      const slidesEl = document.getElementById("slides");
      const contenidoEl = document.getElementById("contenido");

      const estadoEl = document.getElementById("estado");
      const resultadoEl = document.getElementById("resultado");
      const loader = document.getElementById("loader");

      const titulo = (tituloEl.value || "").trim();
      const numDiapositivas = slidesEl.value;
      const contenido = (contenidoEl.value || "").trim();
      const motorIA = currentEngine || "nova";

      if (!contenido) {
        estadoEl.innerText = t.errorContenido;
        return;
      }

      estadoEl.innerText = t.estadoProcesando;
      if (loader) loader.style.display = "block";
      if (resultadoEl) resultadoEl.innerHTML = "";

      try {
        const response = await fetch(`${API_BASE_URL}/generar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          mode: "cors",
          body: JSON.stringify({
            titulo,
            num_diapositivas: numDiapositivas,
            contenido,
            motorIA
          })
        });

        if (!response.ok) {
          estadoEl.innerText = t.errorConexion;
          if (loader) loader.style.display = "none";
          return;
        }

        const data = await response.json().catch(() => ({}));
        PRESENTACION_PRO = data;

        estadoEl.innerText = data.mensaje || t.ok;
        console.log("‚úÖ PRESENTACION_PRO guardada:", PRESENTACION_PRO);

        if (Array.isArray(data.estructura)) {
          estructuraGenerada = data.estructura;

          // Estructura limpia directa del backend
          ultimaEstructuraLimpia = data.estructura.map(x => ({
            title: (x.title || x.titulo || "").trim(),
            bullets: Array.isArray(x.bullets) ? x.bullets : []
          }));

          planPro = aplicarReglasPro(construirPlanPro(ultimaEstructuraLimpia));
          renderPlanPro(planPro);

          document.getElementById("btnPPT").disabled = false;
          document.getElementById("btnPPT2").disabled = false;
        }
      } catch (err) {
        console.error(err);
        estadoEl.innerText = t.errorConexion;
      } finally {
        window.EXPORTANDO_PPT = false;
      }
    }
    
  function normalizarImagenParaPPT(imageInput) {
    if (!imageInput || typeof imageInput !== "string") return null;

    // Caso 1: ya viene como dataURL (lo normal en vuestro proyecto)
    if (imageInput.startsWith("data:image/")) {
      const [meta, base64] = imageInput.split(",");
      const ext = meta.includes("image/jpeg") ? "jpeg" :
              meta.includes("image/jpg")  ? "jpg"  :
              meta.includes("image/png")  ? "png"  : "png";

    return { base64, ext };
    }

    // Caso 2: viene como URL (por si en el futuro se usa)
    return null; // NO convertir aqu√≠ para no meter asincron√≠a
  }
     function base64ToBlobUrl(base64, mime = "image/png") {
      const byteChars = atob(base64);
      const byteNumbers = new Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) {
        byteNumbers[i] = byteChars.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: mime });
      return URL.createObjectURL(blob);
    }
     function base64ToUint8Array(base64) {
       const binary = atob(base64);
       const len = binary.length;
       const bytes = new Uint8Array(len);
       for (let i = 0; i < len; i++) {
         bytes[i] = binary.charCodeAt(i);
       }
       return bytes;
    }

    // =========================
    // EXPORTAR PPTX
    // =========================
    async function exportarPPT() {
      
      if (window.EXPORTANDO_PPT) {
        console.warn("‚õî Exportaci√≥n ya en curso, se ignora llamada duplicada");
        return;
      }
      window.EXPORTANDO_PPT = true;
      
      try {

      const loader = document.getElementById("loader");
      const b1 = document.getElementById("btnPPT");
      const b2 = document.getElementById("btnPPT2");

      if (loader) loader.style.display = "block";
      if (b1) b1.disabled = true;
      if (b2) b2.disabled = true;

        if (!PRESENTACION_PRO) {
          alert("‚ùå Primero genera la presentaci√≥n con IA.");
          return;
        }
        if (!Array.isArray(ultimaEstructuraLimpia) || ultimaEstructuraLimpia.length === 0) {
          alert("‚ùå Primero genera una presentaci√≥n.");
          return;
        }
        if (typeof PptxGenJS === "undefined") {
          alert("‚ùå No se ha cargado la librer√≠a de PowerPoint. Recarga la p√°gina.");
          return;
        }
        
        const titulo = (document.getElementById("titulo")?.value || "Nova_Presentacion").trim();
        const safeTitle = titulo.replace(/[^\w\-]+/g, "_").slice(0, 40) || "Nova_Presentacion";
        const fileName = `${safeTitle}_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-")}.pptx`;

        console.log("‚è≥ Exportando PPTX con im√°genes IA...");

        const pptx = new PptxGenJS();

        // Plan final
        let planParaExportar = (Array.isArray(planPro) && planPro.length)
          ? planPro
          : aplicarReglasPro(construirPlanPro(ultimaEstructuraLimpia));

        // IA REAL (Imagen)
        planParaExportar = await prepararAssetsIA(planParaExportar);
        
        if (!Array.isArray(planParaExportar) || planParaExportar.length === 0) {
          console.warn("‚ö†Ô∏è prepararAssetsIA devolvi√≥ vac√≠o, usando plan original");
          planParaExportar = planPro;
        }

        // DEBUG
        console.log("üß† PLAN FINAL PARA EXPORTAR (DEBUG):",
          planParaExportar.map(s => ({
            idx: s.idx,
            title: s.title,
            needsImage: !!s?.needs?.image,
            imgLen: (s.imageData ? s.imageData.length : 0),
            imgHead: (s.imageData ? String(s.imageData).slice(0, 30) : ""),
            needsChart: !!s?.needs?.chart,
            hasChartSpec: !!s.chartSpec
          }))
        );
        
        console.log("PLAN LENGTH:", planParaExportar.length);

        for (let i = 0; i < planParaExportar.length; i++) {
          const s = planParaExportar[i];
          if (!s || !s.title) continue;

          const idx = s.idx || (i + 1);
          console.log("CREANDO SLIDE idx:", i + 1);
          const slide = pptx.addSlide();

          // Fondo blanco
          slide.background = { color: "FFFFFF" };

        // Reborde azul en TODAS
        slide.addShape(pptx.ShapeType.rect, {
          x: 0.15,
          y: 0.15,
          w: 9.7,
          h: 5.3,
          fill: { color: "FFFFFF", transparency: 100 },
          line: { color: "60A5FA", width: 2 }
        });

        // T√≠tulo
        slide.addText(s.title, {
          x: 0.6,
          y: 0.45,
          w: 9,
          h: 0.6,
          fontSize: 26,
          bold: true,
          color: "111111"
        });

        // Layout seguro
        const textBox = (s.render && s.render.text) || { x: 0.7, y: 1.6, w: 4.4, h: 3.7 };
        let imgBox = { x: 5.0, y: 1.4, w: 4.3, h: 3.7 };
        const chartBox = { x: 5.0, y: 1.4, w: 4.3, h: 3.7 };

        // Slides clave: imagen grande
        if (idx === 1 || idx === 6 || idx === 9 || idx === 10) {
          imgBox = { x: 4.8, y: 1.2, w: 4.7, h: 4.0 };
        }

        // TEXTO (siempre)
        const bullets = Array.isArray(s.bullets) ? s.bullets : [];
        let texto = bullets.length ? bullets.map(b => `- ${b}`).join("\n") : "- Idea principal";
          
        if (!texto || texto.trim() === "") {
          texto = "- Contenido generado por IA";
        }
        slide.addText(texto, {
          x: textBox.x,
          y: textBox.y,
          w: textBox.w,
          h: textBox.h,
          fontSize: 16,
          wrap: true,
          color: "111111"
        });
          
        // IMAGEN
        if (s?.needs?.image || s?.needsImage) {
          let imgBox = { x: 5.0, y: 1.4, w: 4.3, h: 3.7 };

          if (idx === 1 || idx === 6 || idx === 9 || idx === 10) {
            imgBox = { x: 4.8, y: 1.2, w: 4.7, h: 4.0 };
          }
          
          if (!imgDataUrl || imgDataUrl.length < 2000) {
            console.warn("‚ö†Ô∏è Imagen incompleta para idx:", idx);
            continue;
          }

          if (imgNorm && imgNorm.base64) {
            console.log(
              "IMG TEST:",
              imgNorm.base64.slice(0, 80)
          );
            
              const raw = imgNorm.base64
                .replace(/^data:image\/[^;]+;base64,/, "")
                .replace(/^image\/[^;]+;base64,/, "");

              let pptData = "data:image/png;base64," + raw;
            
              const src = s.imageData || s.imgHead;          // ‚Üê usa la imagen completa si existe
              const base64Clean = (src && src.includes(",")) ? src.split(",")[1] : "";
             
        // 1) DataURL completo
        const imgDataUrl = toPptxDataUrl(s.imageData || s.imgHead);

        // 2) Guard-rail
        if (!imgDataUrl || imgDataUrl.length < 2000) {
          console.warn("‚ö†Ô∏è Imagen incompleta para idx:", idx);

          slide.addText("[Imagen no disponible]", {
            x: imgBox.x,
            y: imgBox.y,
            w: imgBox.w,
            h: imgBox.h,
            fontSize: 12,
            align: "center",
            valign: "middle",
            color: "666666"
          });

        } else {
          // 3) base64 limpio + header correcto
          const raw = (imgDataUrl.split(",")[1] || "").replace(/\s/g, "");
          const pptData = "image/png;base64," + raw;

          slide.addImage({
            data: pptData,
            x: imgBox.x,
            y: imgBox.y,
            w: imgBox.w,
            h: imgBox.h,
            sizing: { type: "contain" }
          });
        } 
          
        // GR√ÅFICO
        if (s.needs?.chart) {
          if (s.chartSpec && Array.isArray(s.chartSpec.labels) && Array.isArray(s.chartSpec.values)) {
            const spec = s.chartSpec;
            
            if (!spec.labels || !spec.values || spec.labels.length !== spec.values.length) {
              console.warn("Gr√°fico inv√°lido, se omite");
            } else {
              
              // addChart normal
            }

            slide.addChart(
              spec.type === "line"
                ? pptx.ChartType.line
                : spec.type === "pie"
                ? pptx.ChartType.pie
                : pptx.ChartType.bar,
              [{
                name: spec.title || s.title,
                labels: spec.labels,
                values: spec.values
              }],
              {
                x: chartBox.x,
                y: chartBox.y,
                w: chartBox.w,
                h: chartBox.h,
                title: spec.title || s.title,
                showLegend: true
              }
            );
          } else {
            slide.addText("[Gr√°fico no disponible]", {
              x: chartBox.x,
              y: chartBox.y,
              w: chartBox.w,
              h: chartBox.h,
              fontSize: 12,
              align: "center",
              valign: "middle",
              color: "444444"
            });
          }
        }  // ‚úÖ ESTA ES LA LLAVE QUE TE FALTABA (CIERRA EL FOR)

      console.log("üü¢ Exportando PPT:", fileName);
            
    try {
      await pptx.writeFile({ fileName });
      console.log("‚úÖ PPTX exportado correctamente");
          
    } catch (err) {
        console.error("üî• Fallo exportando PPT:", err);
        alert("‚ùå Error exportando PPT. Mira consola (F12).");
      } finally {
        window.EXPORTANDO_PPT = false;  
      }
        const loader = document.getElementById("loader");
        const b1f = document.getElementById("btnPPT");
        const b2f = document.getElementById("btnPPT2");

        if (b1f) b1f.disabled = false;
        if (b2f) b2f.disabled = false;
        if (loader) loader.style.display = "none";
      }
    
    // ======================
    // ENGANCHE √öNICO BOTONES EXPORTAR
    // ======================
    const btn1 = document.getElementById("btnPPT");
    if (btn1) btn1.onclick = exportarPPT;

    const btn2 = document.getElementById("btnPPT2");
    if (btn2) btn2.onclick = exportarPPT;
    }
    }
        
</script>
</body>
</html>
