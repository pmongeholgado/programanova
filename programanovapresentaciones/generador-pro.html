<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Generador de Presentaciones ¬∑ Nova</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #0c0f17;
                color: #e5e7eb;
                margin: 0;
                padding: 24px;
            }

            h1 {
                text-align: center;
                color: #5ddcff;
            }

            .box {
                max-width: 640px;
                margin: auto;
                background: rgba(255,255,255,0.04);
                border: 1px solid rgba(255,255,255,0.1);
                padding: 24px;
                border-radius: 12px;
            }

            label {
                font-weight: bold;
            }

            input, textarea, select {
                width: 100%;
                padding: 12px;
                margin-top: 8px;
                margin-bottom: 16px;
                border-radius: 8px;
                border: none;
            }

            button {
                width: 100%;
                padding: 14px;
                background: linear-gradient(90deg, #1e90ff, #00c2ff);
                border: none;
                border-radius: 8px;
                color: white;
                font-size: 18px;
                cursor: pointer;
            }

            button:hover {
                background: linear-gradient(90deg, #00c2ff, #1e90ff);
            }

            .estado {
                text-align: center;
                margin-top: 20px;
                color: #7dd3fc;
                font-weight: bold;
            }

        #resultado {
            margin-top: 24px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 16px;
            border-radius: 10px;
        }

        #resultado h3 {
            color: #5ddcff;
            margin-bottom: 12px;
            text-align: center;
        }

        #resultado ul {
            padding-left: 20px;
        }

        #resultado li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
    </style>
</head>

<body>

<h1>Generador Nova ¬∑ Presentaciones <span style="font-size:14px; color:#7dd3fc;">PRO</span></h1>

<div style="text-align:center; margin-bottom:16px;">
    <select id="langSelector" onchange="setLanguage(this.value)">
        <option value="es">Espa√±ol</option>
        <option value="en">English</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
    </select>
</div>

<div style="text-align:center; margin-bottom:20px;">
  <label style="font-size:13px; color:#94a3b8; margin-right:6px;">
    Motor IA:
  </label>
  <select id="engineSelector">
    <option value="nova">Nova (simbiosis)</option>
    <option value="openai">OpenAI</option>
    <option value="claude">Claude</option>
    <option value="gemini">Gemini</option>
  </select>
</div>

<div class="box">
    <label for="motorIA">Motor IA (PRO)</label>
    <select id="motorIA" onchange="setMotorIA(this.value)">
        <!-- opciones se cargan por JS -->
    </select>

    <div class="estado" id="estadoMotor" style="margin-top:-6px; margin-bottom:16px; color:#a5b4fc;">
        üß† Motor IA: NOVA (por defecto)
    </div>

    <label for="titulo">T√≠tulo de la presentaci√≥n</label>
    <input type="text" id="titulo" placeholder="Ejemplo: Innovaci√≥n y futuro de la colaboraci√≥n humano-IA" />

    <label for="slides">N√∫mero de diapositivas</label>
    <select id="slides">
        <option value="10">10 diapositivas</option>
        <option value="12">12 diapositivas</option>
        <option value="15">15 diapositivas</option>
        <option value="20">20 diapositivas</option>
    </select>

    <label for="contenido">Contenido base (cap√≠tulo, texto o guion)</label>
    <textarea id="contenido" rows="6" placeholder="Pega aqu√≠ tu cap√≠tulo, texto o guion base‚Ä¶"></textarea>

    <button onclick="generar()">Generar estructura de presentaci√≥n</button>
    <div id="loader" style="display:none; margin-top:10px; font-weight:bold;">
      ‚è≥ Generando...
    </div>
    <div id="estado" style="margin-top:10px;"></div>

    <button id="btnPPT" onclick="exportarPPT()">üì§ Exportar a PPT</button>
    <button id="btnPPT2" onclick="exportarPPT()">üìä Exportar a PowerPoint</button>
    
    <div class="estado" id="estado">üü¢ Generador listo</div>
    <div id="resultado" style="margin-top:20px;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    
<script>
  let estructuraGenerada = [];
  let ultimaEstructuraLimpia = [];
  let PRESENTACION_PRO = null;
  let EXPORTANDO_PPT = false;

  // ====== FASE 2 (PRO) ‚Äî Esqueleto de composici√≥n ======
  let planPro = [];

  function construirPlanPro(slides) {
    return (slides || []).map((s, i) => {
      const title = String(s.title || s.titulo || "").trim();
      const bullets = Array.isArray(s.bullets) ? s.bullets : [];
      const render = {
          title: { x: 0.5, y: 0.4, w: 9, h: 0.8 },
          text:  { x: 0.7, y: 1.4, w: 8.6, h: 4.2 },
          image: null,
          chart: null
        };
      return {
        idx: i + 1,
        title,
        bullets,
        needs: { text: true, image: false, chart: false },
        imagePrompt: "",
        chartSpec: null,
        theme: { mode: "corporate", accent: "#3b82f6" }
      };
    });
  }

  function aplicarReglasPro(plan) {
    return (plan || []).map((slide, i) => {
       if (!slide) return slide;
       slide.needs = slide.needs || {};
       slide.render = slide.render || {};

    // ‚úÖ GARANT√çA PRO ‚Äî m√≠nimo visual siempre (sin depender de keywords)
    const idx = slide.idx || slide.index || slide.numero || (i + 1);

    // M√≠nimo 3 im√°genes (1, 6, 10)
    if (idx === 1 || idx === 6 || idx === 10) {
      slide.needs.image = true;
    }

    // M√≠nimo 2 gr√°ficos (5, 7)
    if (idx === 5 || idx === 7) {
      slide.needs.chart = true;

      slide.chartSpec = slide.chartSpec || {
        type: "bar",
        title: slide.title || "Comparativa",
        labels: ["A", "B", "C"],
        values: [40, 35, 25]
      };
    }
        
      // ‚úÖ FASE 2.4.1 ‚Äî Normalizaci√≥n PRO (evita undefined)
      slide.needs = slide.needs || {};
      slide.needs.text  = true;
      slide.needs.image = !!slide.needs.image;
      slide.needs.chart = !!slide.needs.chart;

      slide.imagePrompt = slide.imagePrompt || "";
      slide.chartSpec   = slide.chartSpec || null;
      slide.theme       = slide.theme || { mode: "corporate", accent: "#3b82f6" };

      const titulo = (slide.title || "").toLowerCase();
      const texto = (slide.bullets || []).join(" ").toLowerCase();
      // ‚úÖ FASE 2.4.1.2 ‚Äî Normalizaci√≥n de contenido
      slide.title = (slide.title || "").trim();
      slide.bullets = Array.isArray(slide.bullets)
        ? slide.bullets.map(b => String(b).trim()).filter(Boolean)
        : [];

      // üß† FASE 2.4.2.1 ‚Äî Intenci√≥n IA por slide
      slide.ai = {
        text: slide.needs.text === true,
        image: slide.needs.image === true,
        chart: slide.needs.chart === true,
        provider: null,   // openai | dalle | stable | midjourney | etc.
        status: "pending" // pending | generated | error
      };

      // Regla 1: gr√°ficos
      if (
        texto.includes("datos") ||
        texto.includes("comparativa") ||
        texto.includes("evoluci√≥n") ||
        texto.includes("porcentaje") ||
        texto.includes("estad√≠stica")
      ) {
        slide.needs.chart = true;

        // üìä Definici√≥n b√°sica del gr√°fico (FASE 2)
        slide.chartSpec = {
          type: "bar",
          title: "Comparativa clave",
          labels: ["Opci√≥n A", "Opci√≥n B", "Opci√≥n C"],
          values: [30, 50, 20]
        };
      }

      // Regla 2: im√°genes
      if (
        titulo.includes("introducci√≥n") ||
        titulo.includes("contexto") ||
        titulo.includes("visi√≥n") ||
        titulo.includes("futuro") ||
        titulo.includes("conclusi√≥n")
      ) {
        slide.needs.image = true;
      }

      // Regla 3: definici√≥n b√°sica de gr√°ficos
      if (slide.needs.chart) {
        slide.chartSpec = {
          type: "bar",
          title: slide.title,
          labels: ["Opci√≥n A", "Opci√≥n B", "Opci√≥n C"],
          values: [40, 35, 25]
         };
        }

  // üñºÔ∏è Regla im√°genes (FASE 2)
  if (
    titulo.includes("introducci√≥n") ||
    titulo.includes("contexto") ||
    titulo.includes("visi√≥n") ||
    titulo.includes("futuro") ||
    titulo.includes("conclusi√≥n") ||
    titulo.includes("resumen")
  ) {
    slide.needs.image = true;
  }

// üß† Prompt sem√°ntico para imagen (FASE 2)
if (slide.needs.image) {
  slide.imagePrompt = `Imagen conceptual profesional sobre: ${slide.title}. 
  Estilo corporativo, limpio, moderno, sin texto, alta calidad.`;
}

// ===== Layout autom√°tico PRO =====
if (slide.needs?.image && slide.needs.chart) {
  slide.render.image = { x: 0.5, y: 1.6, w: 4.2, h: 3.2 };
  slide.render.chart = { x: 5.0, y: 1.6, w: 4.0, h: 3.2 };
  slide.render.text  = { x: 0.5, y: 5.0, w: 8.6, h: 1.6 };
}
else if (slide.needs.image) {
  slide.render.image = { x: 5.0, y: 1.4, w: 4.0, h: 3.6 };
  slide.render.text  = { x: 0.7, y: 1.4, w: 4.0, h: 3.6 };
}
else if (slide.needs.chart) {
  slide.render.chart = { x: 0.7, y: 1.6, w: 8.0, h: 3.6 };
  slide.render.text  = { x: 0.7, y: 5.4, w: 8.0, h: 1.2 };
}
        
// üéØ Ajuste fino: evitar im√°genes en diapositivas demasiado t√©cnicas
if (
  slide.title.toLowerCase().includes("definici√≥n") ||
  slide.title.toLowerCase().includes("tipos") ||
  slide.title.toLowerCase().includes("modelos") ||
  slide.title.toLowerCase().includes("comparativa")
) {
  slide.needs.image = false;
  slide.imagePrompt = "";
}

// üß† Priorizaci√≥n visual (FASE 2)
// Define el tipo de imagen que se necesitar√° m√°s adelante
if (slide.needs.image) {
  if (slide.title.toLowerCase().includes("introducci√≥n")) {
    slide.imagePrompt = "imagen conceptual de inicio, abstracta y profesional";
  } else if (slide.title.toLowerCase().includes("visi√≥n") || slide.title.toLowerCase().includes("futuro")) {
    slide.imagePrompt = "imagen inspiradora sobre futuro y colaboraci√≥n humano-IA";
  } else if (slide.title.toLowerCase().includes("conclusi√≥n") || slide.title.toLowerCase().includes("reflexi√≥n")) {
    slide.imagePrompt = "imagen humana y reflexiva, tono √©tico y responsable";
  } else {
    slide.imagePrompt = "imagen profesional coherente con el contenido de la diapositiva";
  }
}

// üß† FASE 2.4.2.2 ‚Äî Coherencia final de decisiones PRO

// Si hay gr√°fico, aseguramos texto compacto
if (slide.needs.chart) {
  slide.needs.text = true;
}

// Si hay imagen pero no gr√°fico, mantenemos equilibrio
if (slide.needs.image && !slide.needs.chart) {
  slide.needs.text = true;
}

// Si no hay imagen ni gr√°fico, forzamos texto puro
if (!slide.needs.image && !slide.needs.chart) {
  slide.needs.text = true;
}

// üîí Fallback PRO: nunca una diapositiva vac√≠a
if (!slide.needs.text && !slide.needs.image && !slide.needs.chart) {
  slide.needs.text = true;
}

// üß© FASE 2.5.1 ‚Äî Layout base autom√°tico

slide.layout = "text-only";

if (slide.needs.text && slide.needs.image && slide.needs.chart) {
  slide.layout = "text-image-chart";
} else if (slide.needs.text && slide.needs.chart) {
  slide.layout = "text-chart";
} else if (slide.needs.text && slide.needs.image) {
  slide.layout = "text-image";
} else if (slide.needs.image && !slide.needs.text) {
  slide.layout = "image-only";
}

// üéØ FASE 2.5.2 ‚Äî Layout de cierre NOVA (identidad)

if (
  titulo.includes("conclusi√≥n") ||
  titulo.includes("cierre") ||
  titulo.includes("reflexi√≥n") ||
  titulo.includes("visi√≥n final")
) {
  slide.layout = "closing-impact";
  slide.needs.image = true;
  slide.needs.chart = false;
}

// üß© FASE 2.6.1 ‚Äî Inicializaci√≥n de render PRO

slide.render = {
  title: { x: 0.5, y: 0.4, w: 9, h: 0.8 },
  text: null,
  image: null,
  chart: null
};

// üß© FASE 2.6.2 ‚Äî C√°lculo de layout PRO

switch (slide.layout) {

  case "text-only":
    slide.render.text = { x: 0.7, y: 1.4, w: 9, h: 4.5 };
    break;

  case "text-image":
    slide.render.text = { x: 0.5, y: 1.4, w: 4.5, h: 4.5 };
    slide.render.image = { x: 5.2, y: 1.4, w: 4, h: 4 };
    break;

  case "text-chart":
    slide.render.text = { x: 0.5, y: 1.4, w: 4.5, h: 4.5 };
    slide.render.chart = { x: 5.2, y: 1.4, w: 4, h: 4 };
    break;

  case "image-only":
    slide.render.image = { x: 1.5, y: 1.2, w: 7, h: 4.5 };
    break;

  case "closing-impact":
    slide.render.image = { x: 0, y: 0, w: 10, h: 5.6 };
    slide.render.text = { x: 1, y: 4.2, w: 8, h: 1 };
    break;
}
        
    return slide;
    });
  }

  function renderPlanPro(plan) {
      const resultadoEl = document.getElementById("resultado");
      if (!resultadoEl) return;

      resultadoEl.innerHTML += `
        <hr style="margin:24px 0; border-color:#334155;">
        <h3 style="color:#38bdf8;">üß† Plan NOVA PRO (Fase 2)</h3>
        <div style="text-align:center; margin-bottom:12px; font-size:14px; color:#94a3b8;">
          Motor IA activo: <b>${currentEngine || "nova"}</b>
        </div>

        <ul>
          ${(plan || []).map((slide, i) => `
            <li style="margin-bottom:12px;">
              <b>Diapositiva ${i + 1}:</b> ${slide.title}<br>
              üñº Imagen: ${slide.needs?.image ? "S√≠" : "No"}<br>
              üìä Gr√°fico: ${slide.needs?.chart ? "S√≠" : "No"}<br>
              üé® Tema: ${slide.theme?.mode || "corporate"}
            </li>
          `).join("")}
        </ul>
      `;
    }
    
  // ====== i18n ======
  let currentLang = "es";
  
  // ====== FASE 3 ‚Äî Motor de IA ======
  let currentEngine = localStorage.getItem("nova_engine") || "nova";
    
  const textos = {
    es: {
      btnGenerar: "Generar estructura de presentaci√≥n",
      cargando: "Generando...",
      ok: "Estructura creada",
      titulo: "Generador Nova ¬∑ Presentaciones",
      labelTitulo: "T√≠tulo de la presentaci√≥n",
      labelSlides: "N√∫mero de diapositivas",
      labelContenido: "Contenido base (cap√≠tulo, texto o guion)",
      btnPPT: "üì§ Exportar a PPT",
      estadoListo: "üü¢ Generador listo",
      estadoProcesando: "‚è≥ Procesando solicitud‚Ä¶",
      errorContenido: "‚ö†Ô∏è Introduce un texto base antes de generar la presentaci√≥n.",
      errorConexion: "‚ùå No se pudo conectar con el servicio.",
      phTitulo: "Ejemplo: Innovaci√≥n y futuro de la colaboraci√≥n humano-IA",
      phContenido: "Pega aqu√≠ tu cap√≠tulo, texto o guion base‚Ä¶"
    },
    en: {
      titulo: "Nova Presentation Generator",
      labelTitulo: "Presentation title",
      labelSlides: "Number of slides",
      labelContenido: "Base content (chapter, text or script)",
      btnGenerar: "Generate presentation structure",
      btnPPT: "üì§ Export to PPT",
      estadoListo: "üü¢ Generator ready",
      estadoProcesando: "‚è≥ Processing request‚Ä¶",
      errorContenido: "‚ö†Ô∏è Please enter base content before generating.",
      errorConexion: "‚ùå Could not connect to the service.",
      phTitulo: "Example: Innovation and the future of human-AI collaboration",
      phContenido: "Paste your chapter, text, or script here‚Ä¶"
    },
    ja: {
      titulo: "Nova „Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥ÁîüÊàêÂô®",
      labelTitulo: "„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„ÅÆ„Çø„Ç§„Éà„É´",
      labelSlides: "„Çπ„É©„Ç§„ÉâÊï∞",
      labelContenido: "„Éô„Éº„ÇπÂÜÖÂÆπÔºàÁ´†„Éª„ÉÜ„Ç≠„Çπ„Éà„ÉªÂè∞Êú¨Ôºâ",
      btnGenerar: "„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥ÊßãÊàê„ÇíÁîüÊàê",
      btnPPT: "üì§ PPT„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
      estadoListo: "üü¢ Ê∫ñÂÇôÂÆå‰∫Ü",
      estadoProcesando: "‚è≥ Âá¶ÁêÜ‰∏≠‚Ä¶",
      errorContenido: "‚ö†Ô∏è ÁîüÊàê„Åô„ÇãÂâç„Å´ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
      errorConexion: "‚ùå „Çµ„Éº„Éì„Çπ„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
      phTitulo: "‰æãÔºö‰∫∫Èñì„Å®AI„ÅÆÂçîÂÉç„ÅÆÈù©Êñ∞„Å®Êú™Êù•",
      phContenido: "„Åì„Åì„Å´Á´†„ÉªÊú¨Êñá„ÉªÂè∞Êú¨„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ‚Ä¶"
    }
  };

  function setLanguage(lang) {
    const t = textos[lang] || textos.es;
    currentLang = lang;
    localStorage.setItem("nova_lang", lang);

    document.querySelector("h1").innerText = t.titulo + " PRO";
    document.querySelector("label[for='titulo']").innerText = t.labelTitulo;
    document.querySelector("label[for='slides']").innerText = t.labelSlides;
    document.querySelector("label[for='contenido']").innerText = t.labelContenido;

    document.getElementById("titulo").placeholder = t.phTitulo;
    document.getElementById("contenido").placeholder = t.phContenido;

    document.querySelector("button[onclick='generar()']").innerText = t.btnGenerar;
    document.getElementById("btnPPT").innerText = t.btnPPT;
    document.getElementById("estado").innerText = t.estadoListo;
  }

  const API_BASE_URL = "https://programanovabackend-production-a426.up.railway.app";

  const savedLang = localStorage.getItem("nova_lang") || "es";
  document.getElementById("langSelector").value = savedLang;
  setLanguage(savedLang);

// =========================
// FASE 3.1 ‚Äî Motor IA (selector + estado)
// =========================
const AI_ENGINES = [
  { id: "nova",   name: "NOVA (Backend actual)" },
  { id: "openai", name: "OpenAI (GPT) ‚Äî Pr√≥ximamente" },
  { id: "claude", name: "Claude ‚Äî Pr√≥ximamente" },
  { id: "gemini", name: "Gemini ‚Äî Pr√≥ximamente" },
  { id: "mistral", name: "Mistral ‚Äî Pr√≥ximamente" }
];

currentEngine = localStorage.getItem("nova_engine") || "nova";

function initMotorIA() {
  const sel = document.getElementById("motorIA");
  const estado = document.getElementById("estadoMotor");
  if (!sel || !estado) return;

  // Rellenar opciones
  sel.innerHTML = AI_ENGINES.map(e => `<option value="${e.id}">${e.name}</option>`).join("");

  // Selecci√≥n guardada
  if (!AI_ENGINES.some(e => e.id === currentEngine)) currentEngine = "nova";
  sel.value = currentEngine;

  // Pintar estado
  const name = (AI_ENGINES.find(e => e.id === currentEngine) || AI_ENGINES[0]).name;
  estado.innerText = `üß† Motor IA: ${name}`;
}

function setMotorIA(engineId) {
  currentEngine = engineId || "nova";
  localStorage.setItem("nova_engine", currentEngine);

  const estado = document.getElementById("estadoMotor");
  const name = (AI_ENGINES.find(e => e.id === currentEngine) || AI_ENGINES[0]).name;
  if (estado) estado.innerText = `üß† Motor IA: ${name}`;

  console.log("MOTOR IA (PRO) =>", currentEngine);
}

// Inicializa motor IA al cargar
initMotorIA();

  // ====== Limpieza + agrupaci√≥n ======
  function normalizarItem(item) {
    let s = String(item || "").trim();
    s = s.replace(/\*\*/g, "");
    s = s.replace(/^\s*\d+\.\s*/, "");
    s = s.replace(/^\s*-\s*/gm, "");

    let titulo = s;
    let bullets = [];

    const parts = s.split(/\s*-\s*Idea principal:\s*/i);
    if (parts.length > 1) {
      titulo = parts[0].trim();
      const idea = parts.slice(1).join(" - Idea principal: ").trim();
      if (idea) bullets.push(idea);
    }

    const colon = titulo.split(/\s*:\s*/);
    if (colon.length > 1) {
      titulo = colon[0].trim();
      const resto = colon.slice(1).join(": ").trim();
      if (resto) bullets.push(resto);
    }

    const lines = titulo.split("\n").map(l => l.trim()).filter(Boolean);
    if (lines.length > 1) {
      titulo = lines[0];
      bullets = bullets.concat(lines.slice(1));
    }

    return { titulo: titulo.trim(), bullets: bullets.map(b => b.trim()).filter(Boolean) };
  }

  function construirEstructuraLimpia(arr) {
    const out = [];
    for (const it of (arr || [])) {
      const obj = normalizarItem(it);
      if (!(obj.title || obj.titulo)) continue;
      out.push(obj);
    }
    return out;
  }

  function agruparEnSlides(items) {
    const slides = [];
    let current = null;

    for (const it of (items || [])) {
      const text = (it.titulo || "").trim();
      if (!text) continue;

      current = { titulo: text, bullets: Array.isArray(it.bullets) ? it.bullets : [] };
      slides.push(current);
    }
    return slides;
  }

  // ====== GENERAR (√öNICA) ‚Äî aqu√≠ va el await ======
  async function generar() {
    let endpoint = `${API_BASE_URL}/generar`;
      
    const tituloEl = document.getElementById("titulo");
    const slidesEl = document.getElementById("slides");
    const contenidoEl = document.getElementById("contenido");
    const estadoEl = document.getElementById("estado");
    const resultadoEl = document.getElementById("resultado");

    const t = textos[currentLang] || textos.es;

    const titulo = (tituloEl.value || "").trim();
    const numDiapositivas = slidesEl.value;
    const contenido = (contenidoEl.value || "").trim();

      // üîπ FASE 3.1.2 ‚Äî Motor IA seleccionado (PRO)
      const motorIA = currentEngine || "nova";
      console.log("Motor IA seleccionado:", motorIA);
      
      if (!contenido) {
      estadoEl.innerText = t.errorContenido;
      return;
      }

    estadoEl.innerText = t.estadoProcesando;
    resultadoEl.innerHTML = "";

    // ====== FASE 3.1.4.3 ‚Äî Selecci√≥n de motor IA ======
    
    // En el futuro aqu√≠ se podr√°n a√±adir m√°s motores
    switch (currentEngine) {
      case "nova":
      default:
        endpoint = `${API_BASE_URL}/generar`;
        break;
    }
      
    try {
          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              titulo,
              num_diapositivas: numDiapositivas,
              contenido,
              motorIA
            }),
            mode: "cors",
          });
          // PRO: preparado para multi-IA
          if (!response.ok) {
           estadoEl.innerText = t.errorConexion;
           return;
          }

      const data = await response.json().catch(() => ({}));
      PRESENTACION_PRO = data;
      console.log("‚úÖ PRESENTACION_PRO guardada:", PRESENTACION_PRO);
      estadoEl.innerText = data.mensaje || "‚úÖ Estructura generada correctamente.";

      if (Array.isArray(data.estructura)) {

      estructuraGenerada = data.estructura;

      // ‚úÖ Ya viene listo desde backend
      ultimaEstructuraLimpia = Array.isArray(data.estructura) ? data.estructura : [];

      // ‚úÖ PRO: construir plan y aplicar reglas (sobre estructura limpia)
      planPro = aplicarReglasPro(construirPlanPro(ultimaEstructuraLimpia));
      renderPlanPro(planPro);

        // Render normal
        const listaHTML = (ultimaEstructuraLimpia || []).map((obj, i) => {
          const bullets = (obj.bullets && obj.bullets.length)
            ? `<ul>${obj.bullets.map(b => `<li>${b}</li>`).join("")}</ul>`
            : "";
          return `<li><b>${i + 1}. ${obj.title}</b>${bullets}</li>`;
        }).join("");

        resultadoEl.innerHTML += `
          <h3>Estructura generada</h3>
          <ul>${listaHTML}</ul>
        `;

        document.getElementById("btnPPT").disabled = false;
        document.getElementById("btnPPT2").disabled = false;
      }
    } catch (err) {
      console.error(err);
      estadoEl.innerText = t.errorConexion;
    }
  }

  // ====== NOVA PRO ‚Äî PUENTE IA REAL (IMAGEN + GR√ÅFICO) ======
  // Si tu backend a√∫n no tiene estos endpoints, NO rompe nada: seguir√° con placeholders.
  const IA_ENDPOINTS = {
    imagen: "/generar-imagen",   // <- si tu backend usa otro nombre, lo cambiamos aqu√≠
    grafico: "/generar-grafico"  // <- idem
  };

  async function prepararAssetsIA(plan, motorIA) {
    if (!Array.isArray(plan) || !plan.length) return plan;

    for (let i = 0; i < plan.length; i++) {
      const s = plan[i];
      if (!s || !s.needs) continue;

      // üñºÔ∏è IMAGEN REAL
      if (s.needs.image && !s.imageData) {
        try {
          const rImg = await fetch(`${API_BASE_URL}${IA_ENDPOINTS.imagen}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            mode: "cors",
            body: JSON.stringify({
              titulo: s.title,
              prompt: s.imagePrompt || `Imagen conceptual para: ${s.title}`
            })
          });

          if (rImg.ok) {
            const img = await rImg.json().catch(() => ({}));
            // Esperamos { dataUrl: "data:image/png;base64,...." }
            if (img) {
              const dataUrl = img.dataUrl || img.dataURL || img.data_url || "";
              if (dataUrl && String(dataUrl).startsWith("data:image/")) {
                s.imageData = dataUrl;
              }
            }

          }
        } catch (e) {
          console.warn("IA imagen fall√≥:", e);
        }
      }

      // üìä GR√ÅFICO REAL (spec)
      if (s.needs.chart && !s.chartSpec) {
        try {
          const rCh = await fetch(`${API_BASE_URL}${IA_ENDPOINTS.grafico}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            mode: "cors",
            body: JSON.stringify({
              titulo: s.title,
              contexto: (Array.isArray(s.bullets) ? s.bullets.join(" ") : "")
            })
          });

          if (rCh.ok) {
            const ch = await rCh.json().catch(() => ({}));
            // Esperamos { type:"bar|line|pie", title, labels:[], values:[] }
            if (ch) {
              const labels = ch.labels || [];
              const values = ch.values || [];
              if (Array.isArray(labels) && Array.isArray(values) && labels.length >= 3 && labels.length === values.length) {
                s.chartSpec = ch;
            }
          }

          }
        } catch (e) {
          console.warn("IA gr√°fico fall√≥:", e);
        }
      }
    }

    return plan;
  }
    
  function toPptxDataUrl(input) {
    if (!input) return "";

    const s = String(input).trim();

    // Ya viene perfecto
    if (s.startsWith("data:image/")) return s;

    // Viene como "image/png;base64,...." (le falta "data:")
    if (s.startsWith("image/")) return "data:" + s;

    // Viene como "data:image/png;base64,AAA..." pero alguien lo recort√≥ raro
    if (s.includes("base64,") && !s.startsWith("data:")) return "data:" + s;

    // Viene como "AAA..." (base64 puro)
    if (!s.includes(",")) return "data:image/png;base64," + s;

    // Viene con coma (dataUrl o pseudo-dataUrl)
    const parts = s.split(",");
    const head = parts[0] || "";
    const b64 = parts[1] || "";

    if (head.startsWith("data:image/")) return s;
    if (head.startsWith("image/")) return "data:" + head + "," + b64;

    // Cualquier otra cosa ‚Üí nos quedamos con el b64
    return "data:image/png;base64," + b64;
  }
    
  // ====== Export ======
async function exportarPPT() {
  if (EXPORTANDO_PPT) {
    console.warn("‚õî Exportaci√≥n ya en curso, ignorando segundo click...");
    return;
  }

  EXPORTANDO_PPT = true;

  const loader = document.getElementById("loader");
  const b1 = document.getElementById("btnPPT");
  const b2 = document.getElementById("btnPPT2");

  // Encender loader y bloquear botones
  if (loader) loader.style.display = "block";
  if (b1) b1.disabled = true;
  if (b2) b2.disabled = true;

  try {
    // ‚úÖ Validaciones
    if (!PRESENTACION_PRO) {
      alert("‚ùå Primero genera la presentaci√≥n con IA.");
      return;
    }
    if (!Array.isArray(ultimaEstructuraLimpia) || ultimaEstructuraLimpia.length === 0) {
      alert("‚ùå Primero genera una presentaci√≥n.");
      return;
    }
    if (typeof PptxGenJS === "undefined") {
      alert("‚ùå No se ha cargado la librer√≠a de PowerPoint. Recarga la p√°gina.");
      return;
    }

    // ‚úÖ Nombre de archivo
    const titulo = (document.getElementById("titulo")?.value || "Nova_Presentacion").trim();
    const safeTitle = titulo.replace(/[^\w\-]+/g, "_").slice(0, 40) || "Nova_Presentacion";
    const fileName = `${safeTitle}_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-")}.pptx`;

    console.log("‚è≥ Exportando PPTX con im√°genes IA...");

    const pptx = new PptxGenJS();

    // ‚úÖ Construir plan PRO FINAL
    let planParaExportar = (Array.isArray(planPro) && planPro.length)
      ? planPro
      : aplicarReglasPro(construirPlanPro(ultimaEstructuraLimpia));

    if (!Array.isArray(planParaExportar) || planParaExportar.length === 0) {
      alert("‚ùå No se pudo construir el plan PRO para exportar.");
      return;
    }

    // ‚úÖ IA REAL entra aqu√≠
    const motorIA = currentEngine || "nova";
    planParaExportar = await prepararAssetsIA(planParaExportar, motorIA);

    // ‚úÖ DEBUG (como ya tienes en consola)
    console.log("üß† PLAN FINAL PARA EXPORTAR (DEBUG):",
      planParaExportar.map(s => ({
        idx: s.idx,
        title: s.title,
        needsImage: !!s?.needs?.image,
        imgLen: (s.imageData ? s.imageData.length : 0),
        imgHead: (s.imageData ? String(s.imageData).slice(0, 30) : ""),
        needsChart: !!s?.needs?.chart,
        hasChartSpec: !!s.chartSpec
      }))
    );

    // ‚úÖ Slides
    for (let i = 0; i < planParaExportar.length; i++) {
      const s = planParaExportar[i];
      if (!s || !s.title) continue;

      const slide = pptx.addSlide();

      // Fondo blanco
      slide.background = { color: "FFFFFF" };

      // ‚úÖ Reborde azul en TODAS
      slide.addShape(pptx.ShapeType.rect, {
        x: 0.15,
        y: 0.15,
        w: 9.7,
        h: 5.3,
        fill: { color: "FFFFFF", transparency: 100 },
        line: { color: "60A5FA", width: 2 }
      });

      // T√≠tulo (siempre visible)
      slide.addText(s.title, {
        x: 0.6,
        y: 0.45,
        w: 9,
        h: 0.6,
        fontSize: 26,
        bold: true,
        color: "111111"
      });

      // Layout seguro
      const textBox = (s.render && s.render.text) || { x: 0.7, y: 1.6, w: 4.4, h: 3.7 };
      const imgBox  = (s.render && s.render.image) || { x: 5.3, y: 1.6, w: 4.1, h: 3.7 };
      const chartBox = (s.render && s.render.chart) || { x: 5.3, y: 1.6, w: 4.1, h: 3.7 };

      // ‚úÖ TEXTO (SIEMPRE)
      const bullets = Array.isArray(s.bullets) ? s.bullets : [];
      const texto = bullets.length ? bullets.map(b => `- ${b}`).join("\n") : "- Idea principal";

      slide.addText(texto, {
        x: textBox.x,
        y: textBox.y,
        w: textBox.w,
        h: textBox.h,
        fontSize: 16,
        wrap: true,
        color: "111111"
      });

      // ‚úÖ IMAGEN (si toca)
      if (s.needs?.image) {
        if (s.imageData && String(s.imageData).startsWith("data:image/")) {
          slide.addImage({
            data: toPptxDataUrl(s.imageData),
            x: imgBox.x,
            y: imgBox.y,
            w: imgBox.w,
            h: imgBox.h
          });
        } else {
          slide.addText("[Imagen no disponible]", {
            x: imgBox.x,
            y: imgBox.y,
            w: imgBox.w,
            h: imgBox.h,
            fontSize: 12,
            align: "center",
            valign: "middle",
            color: "666666"
          });
        }
      }

      // ‚úÖ GR√ÅFICO (si toca)
      if (s.needs?.chart) {
        if (s.chartSpec && Array.isArray(s.chartSpec.labels) && Array.isArray(s.chartSpec.values)) {
          const spec = s.chartSpec;

          slide.addChart(
            spec.type === "line"
              ? pptx.ChartType.line
              : spec.type === "pie"
              ? pptx.ChartType.pie
              : pptx.ChartType.bar,
            [{
              name: spec.title || s.title,
              labels: spec.labels,
              values: spec.values
            }],
            {
              x: chartBox.x,
              y: chartBox.y,
              w: chartBox.w,
              h: chartBox.h,
              title: spec.title || s.title,
              showLegend: true
            }
          );
        } else {
          slide.addText("[Gr√°fico no disponible]", {
            x: chartBox.x,
            y: chartBox.y,
            w: chartBox.w,
            h: chartBox.h,
            fontSize: 12,
            align: "center",
            valign: "middle",
            color: "444444"
          });
        }
      }
    }

    // ‚úÖ Export real
    console.log("üü¢ Exportando PPT:", fileName);
    await pptx.writeFile({ fileName });
    console.log("‚úÖ PPTX exportado correctamente");

  } catch (err) {
    console.error("üî• Fallo exportando PPT:", err);
    alert("‚ùå Error exportando PPT. Mira consola (F12).");
  } finally {
    // ‚úÖ √öNICO sitio de desbloqueo (no duplicar nunca)
    EXPORTANDO_PPT = false;

    const loader = document.getElementById("loader");
    const b1f = document.getElementById("btnPPT");
    const b2f = document.getElementById("btnPPT2");

    if (b1f) b1f.disabled = false;
    if (b2f) b2f.disabled = false;
    if (loader) loader.style.display = "none";
  }
}       
    
</script>
</body>
</html>
