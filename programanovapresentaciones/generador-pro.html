<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generador de Presentaciones ¬∑ Nova</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0c0f17;
      color: #e5e7eb;
      margin: 0;
      padding: 24px;
    }
    h1 { text-align: center; color: #5ddcff; }
    .box {
      max-width: 640px;
      margin: auto;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 24px;
      border-radius: 12px;
    }
    label { font-weight: bold; }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: none;
    }
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(90deg, #1e90ff, #00c2ff);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 18px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: linear-gradient(90deg, #00c2ff, #1e90ff);
    }
    .estado {
      text-align: center;
      margin-top: 14px;
      color: #7dd3fc;
      font-weight: bold;
    }
    #resultado {
      margin-top: 24px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 16px;
      border-radius: 10px;
    }
    #resultado h3 {
      color: #5ddcff;
      margin-bottom: 12px;
      text-align: center;
    }
    #resultado ul { padding-left: 20px; }
    #resultado li { margin-bottom: 8px; line-height: 1.4; }
  </style>
</head>

<body>

<h1>Generador Nova ¬∑ Presentaciones <span style="font-size:14px; color:#7dd3fc;">PRO</span></h1>

<div style="text-align:center; margin-bottom:16px;">
  <select id="langSelector" onchange="setLanguage(this.value)">
    <option value="es">Espa√±ol</option>
    <option value="en">English</option>
    <option value="ja">Êó•Êú¨Ë™û</option>
  </select>
</div>

<div class="box">
  <label for="motorIA">Motor IA (PRO)</label>
  <select id="motorIA" onchange="setMotorIA(this.value)"></select>

  <div class="estado" id="estadoMotor" style="margin-top:-6px; margin-bottom:16px; color:#a5b4fc;">
    üß† Motor IA: NOVA (por defecto)
  </div>

  <label for="titulo">T√≠tulo de la presentaci√≥n</label>
  <input type="text" id="titulo" placeholder="Ejemplo: Innovaci√≥n y futuro de la colaboraci√≥n humano-IA" />

  <label for="slides">N√∫mero de diapositivas</label>
  <select id="slides">
    <option value="10">10 diapositivas</option>
    <option value="12">12 diapositivas</option>
    <option value="15">15 diapositivas</option>
    <option value="20">20 diapositivas</option>
  </select>

  <label for="contenido">Contenido base (cap√≠tulo, texto o guion)</label>
  <textarea id="contenido" rows="6" placeholder="Pega aqu√≠ tu cap√≠tulo, texto o guion base‚Ä¶"></textarea>

  <button id="btnGenerar" onclick="generar()">Generar estructura de presentaci√≥n</button>

  <div id="loader" style="display:none; margin-top:10px; font-weight:bold;">
    ‚è≥ Procesando...
  </div>

  <div class="estado" id="estado">üü¢ Generador listo</div>

  <button id="btnPPT" onclick="exportarPPT()" disabled>üì§ Exportar a PPT</button>
  <button id="btnPPT2" onclick="exportarPPT()" disabled>üìä Exportar a PowerPoint</button>

  <div id="resultado"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<script>
  // ======================
  // VARIABLES GLOBALES
  // ======================
  let estructuraGenerada = [];
  let ultimaEstructuraLimpia = [];
  let PRESENTACION_PRO = null;
  let EXPORTANDO_PPT = false;
  let planPro = [];

  const API_BASE_URL = "https://programanovabackend-production-a426.up.railway.app";

  // ======================
  // i18n
  // ======================
  let currentLang = localStorage.getItem("nova_lang") || "es";
  const textos = {
    es: {
      titulo: "Generador Nova ¬∑ Presentaciones",
      btnGenerar: "Generar estructura de presentaci√≥n",
      btnPPT: "üì§ Exportar a PPT",
      estadoListo: "üü¢ Generador listo",
      estadoProcesando: "‚è≥ Procesando solicitud‚Ä¶",
      errorContenido: "‚ö†Ô∏è Introduce un texto base antes de generar la presentaci√≥n.",
      errorConexion: "‚ùå No se pudo conectar con el servicio.",
      phTitulo: "Ejemplo: Innovaci√≥n y futuro de la colaboraci√≥n humano-IA",
      phContenido: "Pega aqu√≠ tu cap√≠tulo, texto o guion base‚Ä¶"
    },
    en: {
      titulo: "Nova Presentation Generator",
      btnGenerar: "Generate presentation structure",
      btnPPT: "üì§ Export to PPT",
      estadoListo: "üü¢ Generator ready",
      estadoProcesando: "‚è≥ Processing request‚Ä¶",
      errorContenido: "‚ö†Ô∏è Please enter base content before generating.",
      errorConexion: "‚ùå Could not connect to the service.",
      phTitulo: "Example: Innovation and the future of human-AI collaboration",
      phContenido: "Paste your chapter, text, or script here‚Ä¶"
    },
    ja: {
      titulo: "Nova „Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥ÁîüÊàêÂô®",
      btnGenerar: "„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥ÊßãÊàê„ÇíÁîüÊàê",
      btnPPT: "üì§ PPT„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
      estadoListo: "üü¢ Ê∫ñÂÇôÂÆå‰∫Ü",
      estadoProcesando: "‚è≥ Âá¶ÁêÜ‰∏≠‚Ä¶",
      errorContenido: "‚ö†Ô∏è ÁîüÊàê„Åô„ÇãÂâç„Å´ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
      errorConexion: "‚ùå „Çµ„Éº„Éì„Çπ„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
      phTitulo: "‰æãÔºö‰∫∫Èñì„Å®AI„ÅÆÂçîÂÉç„ÅÆÈù©Êñ∞„Å®Êú™Êù•",
      phContenido: "„Åì„Åì„Å´Á´†„ÉªÊú¨Êñá„ÉªÂè∞Êú¨„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ‚Ä¶"
    }
  };

  function setLanguage(lang) {
    currentLang = lang || "es";
    localStorage.setItem("nova_lang", currentLang);

    const t = textos[currentLang] || textos.es;

    document.querySelector("h1").innerText = t.titulo + " PRO";
    document.querySelector("label[for='titulo']").innerText = (currentLang === "es") ? "T√≠tulo de la presentaci√≥n" : (currentLang === "en") ? "Presentation title" : "„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„ÅÆ„Çø„Ç§„Éà„É´";
    document.querySelector("label[for='slides']").innerText = (currentLang === "es") ? "N√∫mero de diapositivas" : (currentLang === "en") ? "Number of slides" : "„Çπ„É©„Ç§„ÉâÊï∞";
    document.querySelector("label[for='contenido']").innerText = (currentLang === "es") ? "Contenido base (cap√≠tulo, texto o guion)" : (currentLang === "en") ? "Base content (chapter, text or script)" : "„Éô„Éº„ÇπÂÜÖÂÆπÔºàÁ´†„Éª„ÉÜ„Ç≠„Çπ„Éà„ÉªÂè∞Êú¨Ôºâ";

    document.getElementById("titulo").placeholder = t.phTitulo;
    document.getElementById("contenido").placeholder = t.phContenido;

    document.getElementById("btnGenerar").innerText = t.btnGenerar;
    document.getElementById("btnPPT").innerText = t.btnPPT;
    document.getElementById("estado").innerText = t.estadoListo;
  }

  // ======================
  // Motor IA (selector)
  // ======================
  const AI_ENGINES = [
    { id: "nova",   name: "NOVA (Backend actual)" },
    { id: "openai", name: "OpenAI (GPT) ‚Äî Pr√≥ximamente" },
    { id: "claude", name: "Claude ‚Äî Pr√≥ximamente" },
    { id: "gemini", name: "Gemini ‚Äî Pr√≥ximamente" }
  ];

  let currentEngine = localStorage.getItem("nova_engine") || "nova";

  function initMotorIA() {
    const sel = document.getElementById("motorIA");
    const estado = document.getElementById("estadoMotor");
    if (!sel || !estado) return;

    sel.innerHTML = AI_ENGINES.map(e => `<option value="${e.id}">${e.name}</option>`).join("");

    if (!AI_ENGINES.some(e => e.id === currentEngine)) currentEngine = "nova";
    sel.value = currentEngine;

    const name = (AI_ENGINES.find(e => e.id === currentEngine) || AI_ENGINES[0]).name;
    estado.innerText = `üß† Motor IA: ${name}`;
  }

  function setMotorIA(engineId) {
    currentEngine = engineId || "nova";
    localStorage.setItem("nova_engine", currentEngine);

    const estado = document.getElementById("estadoMotor");
    const name = (AI_ENGINES.find(e => e.id === currentEngine) || AI_ENGINES[0]).name;
    if (estado) estado.innerText = `üß† Motor IA: ${name}`;

    console.log("MOTOR IA (PRO) =>", currentEngine);
  }

  // ======================
  // PLAN PRO
  // ======================
  function construirPlanPro(slides) {
    return (slides || []).map((s, i) => {
      const title = String(s.title || s.titulo || "").trim();
      const bullets = Array.isArray(s.bullets) ? s.bullets : [];
      return {
        idx: i + 1,
        title,
        bullets,
        needs: { text: true, image: false, chart: false },
        imagePrompt: "",
        chartSpec: null,
        render: { text: null, image: null, chart: null }
      };
    });
  }

  function aplicarReglasPro(plan) {
    return (plan || []).map((slide, i) => {
      if (!slide) return slide;

      const idx = slide.idx || (i + 1);

      slide.needs = slide.needs || { text: true, image: false, chart: false };
      slide.needs.text = true;

      // Garant√≠as
      if (idx === 1 || idx === 6 || idx === 9 || idx === 10) slide.needs.image = true;
      if (idx === 5 || idx === 7) slide.needs.chart = true;

      // Prompt imagen
      if (slide.needs.image) {
        slide.imagePrompt = slide.imagePrompt || `Imagen conceptual profesional sobre: ${slide.title}. Estilo corporativo, moderno, sin texto.`;
      }

      // Spec gr√°fico por defecto
      if (slide.needs.chart && !slide.chartSpec) {
        slide.chartSpec = (idx === 7)
          ? { type:"line", title:"Evoluci√≥n", labels:["2022","2023","2024"], values:[20,45,70] }
          : { type:"bar", title:"Comparativa", labels:["A","B","C"], values:[40,35,25] };
      }

      return slide;
    });
  }

  function renderPlanPro(plan) {
    const resultadoEl = document.getElementById("resultado");
    if (!resultadoEl) return;

    resultadoEl.innerHTML += `
      <hr style="margin:24px 0; border-color:#334155;">
      <h3 style="color:#38bdf8;">üß† Plan NOVA PRO</h3>
      <div style="text-align:center; margin-bottom:12px; font-size:14px; color:#94a3b8;">
        Motor IA activo: <b>${currentEngine || "nova"}</b>
      </div>
      <ul>
        ${(plan || []).map((s, i) => `
          <li style="margin-bottom:12px;">
            <b>Diapositiva ${i + 1}:</b> ${s.title}<br>
            üñº Imagen: ${s.needs?.image ? "S√≠" : "No"}<br>
            üìä Gr√°fico: ${s.needs?.chart ? "S√≠" : "No"}
          </li>
        `).join("")}
      </ul>
    `;
  }

  // ======================
  // IA ASSETS
  // ======================
  const IA_ENDPOINTS = {
    imagen: "/generar-imagen"
  };

  function toPptxDataUrl(input) {
    if (!input) return "";
    const s = String(input).trim();
    if (s.startsWith("data:image/")) return s;
    if (s.startsWith("image/")) return "data:" + s;
    if (s.includes("base64,") && !s.startsWith("data:")) return "data:" + s;
    if (!s.includes(",")) return "data:image/png;base64," + s;
    return s;
  }

  async function prepararAssetsIA(plan) {
    if (!Array.isArray(plan) || !plan.length) return plan;

    for (let i = 0; i < plan.length; i++) {
      const s = plan[i];
      if (!s || !s.needs) continue;

      if (s.needs.image && !s.imageData) {
        try {
          const rImg = await fetch(`${API_BASE_URL}${IA_ENDPOINTS.imagen}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            mode: "cors",
            body: JSON.stringify({
              titulo: s.title,
              prompt: s.imagePrompt || `Imagen conceptual para: ${s.title}`
            })
          });

          if (rImg.ok) {
            const img = await rImg.json().catch(() => ({}));
            const dataUrl = img.dataUrl || img.dataURL || img.data_url || "";
            if (dataUrl && String(dataUrl).startsWith("data:image/")) {
              s.imageData = dataUrl;
            }
          }
        } catch (e) {
          console.warn("IA imagen fall√≥:", e);
        }
      }
    }
    return plan;
  }

  // ======================
  // GENERAR
  // ======================
  async function generar() {
    const t = textos[currentLang] || textos.es;

    const titulo = (document.getElementById("titulo").value || "").trim();
    const numDiapositivas = document.getElementById("slides").value;
    const contenido = (document.getElementById("contenido").value || "").trim();

    const estadoEl = document.getElementById("estado");
    const resultadoEl = document.getElementById("resultado");
    const loader = document.getElementById("loader");

    if (!contenido) {
      estadoEl.innerText = t.errorContenido;
      return;
    }

    estadoEl.innerText = t.estadoProcesando;
    resultadoEl.innerHTML = "";
    if (loader) loader.style.display = "block";

    try {
      const response = await fetch(`${API_BASE_URL}/generar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        mode: "cors",
        body: JSON.stringify({
          titulo,
          num_diapositivas: numDiapositivas,
          contenido,
          motorIA: (currentEngine || "nova")
        })
      });

      if (!response.ok) {
        estadoEl.innerText = t.errorConexion;
        return;
      }

      const data = await response.json().catch(() => ({}));
      PRESENTACION_PRO = data;

      estadoEl.innerText = data.mensaje || "‚úÖ Estructura generada correctamente.";

      if (Array.isArray(data.estructura)) {
        ultimaEstructuraLimpia = data.estructura;

        planPro = aplicarReglasPro(construirPlanPro(ultimaEstructuraLimpia));
        renderPlanPro(planPro);

        // Render normal
        const listaHTML = (ultimaEstructuraLimpia || []).map((obj, i) => {
          const bullets = (obj.bullets && obj.bullets.length)
            ? `<ul>${obj.bullets.map(b => `<li>${b}</li>`).join("")}</ul>`
            : "";
          return `<li><b>${i + 1}. ${obj.title}</b>${bullets}</li>`;
        }).join("");

        resultadoEl.innerHTML += `
          <h3>Estructura generada</h3>
          <ul>${listaHTML}</ul>
        `;

        document.getElementById("btnPPT").disabled = false;
        document.getElementById("btnPPT2").disabled = false;
      }
    } catch (err) {
      console.error(err);
      estadoEl.innerText = t.errorConexion;
    } finally {
      if (loader) loader.style.display = "none";
    }
  }

  // ======================
  // EXPORTAR PPTX
  // ======================
  async function exportarPPT() {
    if (EXPORTANDO_PPT) return;

    EXPORTANDO_PPT = true;

    const loader = document.getElementById("loader");
    const b1 = document.getElementById("btnPPT");
    const b2 = document.getElementById("btnPPT2");

    if (loader) loader.style.display = "block";
    if (b1) b1.disabled = true;
    if (b2) b2.disabled = true;

    try {
      if (!Array.isArray(planPro) || planPro.length === 0) {
        alert("‚ùå Primero genera la presentaci√≥n.");
        return;
      }
      if (typeof PptxGenJS === "undefined") {
        alert("‚ùå No se carg√≥ PptxGenJS. Recarga la p√°gina.");
        return;
      }

      const titulo = (document.getElementById("titulo").value || "Nova_Presentacion").trim();
      const safeTitle = titulo.replace(/[^\w\-]+/g, "_").slice(0, 40) || "Nova_Presentacion";
      const fileName = `${safeTitle}_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-")}.pptx`;

      const pptx = new PptxGenJS();

      // üî• preparar im√°genes IA reales
      let planParaExportar = JSON.parse(JSON.stringify(planPro));
      planParaExportar = await prepararAssetsIA(planParaExportar);

      console.log("üß† PLAN FINAL PARA EXPORTAR (DEBUG):",
        planParaExportar.map(s => ({
          idx: s.idx,
          title: s.title,
          needsImage: !!s?.needs?.image,
          imgLen: (s.imageData ? s.imageData.length : 0),
          imgHead: (s.imageData ? String(s.imageData).slice(0, 30) : "")
        }))
      );

      for (let i = 0; i < planParaExportar.length; i++) {
        const s = planParaExportar[i];
        if (!s || !s.title) continue;

        const idx = s.idx || (i + 1);
        const slide = pptx.addSlide();

        slide.background = { color: "FFFFFF" };

        // ‚úÖ Reborde azul siempre
        slide.addShape(pptx.ShapeType.rect, {
          x: 0.15, y: 0.15, w: 9.7, h: 5.3,
          fill: { color: "FFFFFF", transparency: 100 },
          line: { color: "60A5FA", width: 2 }
        });

        slide.addText(s.title, {
          x: 0.6, y: 0.45, w: 9, h: 0.6,
          fontSize: 26, bold: true, color: "111111"
        });

        // Texto
        const bullets = Array.isArray(s.bullets) ? s.bullets : [];
        const texto = bullets.length ? bullets.map(b => `- ${b}`).join("\n") : "- Idea principal";

        slide.addText(texto, {
          x: 0.7, y: 1.6, w: 4.0, h: 3.7,
          fontSize: 16, wrap: true, color: "111111"
        });

        // Imagen
        if (s.needs?.image) {
          let imgBox = { x: 5.0, y: 1.4, w: 4.3, h: 3.7 };

          if (idx === 1 || idx === 6 || idx === 9 || idx === 10) {
            imgBox = { x: 4.8, y: 1.2, w: 4.7, h: 4.0 };
          }

          const imgData = toPptxDataUrl(s.imageData);

          if (imgData && String(imgData).startsWith("data:image/")) {
            slide.addImage({
              data: imgData,
              x: imgBox.x,
              y: imgBox.y,
              w: imgBox.w,
              h: imgBox.h
            });
          } else {
            slide.addText("[Imagen no disponible]", {
              x: imgBox.x, y: imgBox.y, w: imgBox.w, h: imgBox.h,
              fontSize: 12, align: "center", valign: "middle", color: "666666"
            });
          }
        }

        // Gr√°fico
        if (s.needs?.chart && s.chartSpec) {
          const spec = s.chartSpec;
          slide.addChart(
            spec.type === "line" ? pptx.ChartType.line : pptx.ChartType.bar,
            [{
              name: spec.title || s.title,
              labels: spec.labels,
              values: spec.values
            }],
            { x: 5.0, y: 1.4, w: 4.3, h: 3.7, title: spec.title || s.title, showLegend: true }
          );
        }
      }

      console.log("üü¢ Exportando PPT:", fileName);
      await pptx.writeFile({ fileName });
      console.log("‚úÖ PPTX exportado correctamente");

    } catch (err) {
      console.error("üî• Fallo exportando PPT:", err);
      alert("‚ùå Error exportando PPT. Mira consola (F12).");
    } finally {
      EXPORTANDO_PPT = false;
      const loader2 = document.getElementById("loader");
      const b1f = document.getElementById("btnPPT");
      const b2f = document.getElementById("btnPPT2");
      if (b1f) b1f.disabled = false;
      if (b2f) b2f.disabled = false;
      if (loader2) loader2.style.display = "none";
    }
  }

  // ======================
  // INIT
  // ======================
  document.getElementById("langSelector").value = currentLang;
  setLanguage(currentLang);
  initMotorIA();
</script>

</body>
</html>
