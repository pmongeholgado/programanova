<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Generador de Presentaciones ¬∑ Nova</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #0c0f17;
                color: #e5e7eb;
                margin: 0;
                padding: 24px;
            }

            h1 {
                text-align: center;
                color: #5ddcff;
            }

            .box {
                max-width: 640px;
                margin: auto;
                background: rgba(255,255,255,0.04);
                border: 1px solid rgba(255,255,255,0.1);
                padding: 24px;
                border-radius: 12px;
            }

            label {
                font-weight: bold;
            }

            input, textarea, select {
                width: 100%;
                padding: 12px;
                margin-top: 8px;
                margin-bottom: 16px;
                border-radius: 8px;
                border: none;
            }

            button {
                width: 100%;
                padding: 14px;
                background: linear-gradient(90deg, #1e90ff, #00c2ff);
                border: none;
                border-radius: 8px;
                color: white;
                font-size: 18px;
                cursor: pointer;
            }

            button:hover {
                background: linear-gradient(90deg, #00c2ff, #1e90ff);
            }

            .estado {
                text-align: center;
                margin-top: 20px;
                color: #7dd3fc;
                font-weight: bold;
            }

        #resultado {
            margin-top: 24px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 16px;
            border-radius: 10px;
        }

        #resultado h3 {
            color: #5ddcff;
            margin-bottom: 12px;
            text-align: center;
        }

        #resultado ul {
            padding-left: 20px;
        }

        #resultado li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
    </style>
</head>

<body>

<h1>Generador Nova ¬∑ Presentaciones <span style="font-size:14px; color:#7dd3fc;">PRO</span></h1>

<div style="text-align:center; margin-bottom:16px;">
    <select id="langSelector" onchange="setLanguage(this.value)">
        <option value="es">Espa√±ol</option>
        <option value="en">English</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
    </select>
</div>
    
<div class="box">
    <label for="titulo">T√≠tulo de la presentaci√≥n</label>
    <input type="text" id="titulo" placeholder="Ejemplo: Innovaci√≥n y futuro de la colaboraci√≥n humano-IA" />

    <label for="slides">N√∫mero de diapositivas</label>
    <select id="slides">
        <option value="10">10 diapositivas</option>
        <option value="12">12 diapositivas</option>
        <option value="15">15 diapositivas</option>
        <option value="20">20 diapositivas</option>
    </select>

    <label for="contenido">Contenido base (cap√≠tulo, texto o guion)</label>
    <textarea id="contenido" rows="6" placeholder="Pega aqu√≠ tu cap√≠tulo, texto o guion base‚Ä¶"></textarea>

    <button onclick="generar()">Generar estructura de presentaci√≥n</button>
    <button id="btnPPT" onclick="exportarPPT()" disabled>üì§ Exportar a PPT</button>
    <button id="btnPPT2" onclick="exportarPPT()" disabled>üìä Exportar a PowerPoint</button>
    
    <div class="estado" id="estado">üü¢ Generador listo</div>
    <div id="resultado" style="margin-top:20px;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    
<script>
    let estructuraGenerada = [];
    let ultimaEstructuraLimpia = [];
    // ====== FASE 2 (PRO) ‚Äî Esqueleto de composici√≥n (NO activa a√∫n) ======
    let planPro = []; 
    // planPro ser√° un array de slides con este formato:
    // {
    //   idx: 1,
    //   title: "T√≠tulo",
    //   bullets: ["..."],
    //   needs: { text: true, image: false, chart: false },
    //   imagePrompt: "",
    //   chartSpec: null,
    //   theme: { mode: "corporate", accent: "#3b82f6" }
    // }

    function construirPlanPro(slides) { 
      return (slides || []).map((s, i) => {
        const title = (s.titulo || "").trim();
        const bullets = Array.isArray(s.bullets) ? s.bullets : [];

        // Por defecto: todo es texto.
        // En Fase 2, Nova decidir√° cu√°ndo activar image/chart.
        return {
          idx: i + 1,
          title,
          bullets,
          needs: { text: true, image: false, chart: false },
          imagePrompt: "",
          chartSpec: null,
          theme: { mode: "corporate", accent: "#3b82f6" }
        };
      });
    }
    // ====== FASE 2 ‚Äî Reglas m√≠nimas de decisi√≥n (heur√≠sticas simples) ======
    function aplicarReglasPro(plan) {
      return plan.map(slide => {
        const titulo = slide.title.toLowerCase();
        const texto = slide.bullets.join(" ").toLowerCase();

        // Regla 1: gr√°ficos
        if (
          texto.includes("datos") ||
          texto.includes("comparativa") ||
          texto.includes("evoluci√≥n") ||
          texto.includes("porcentaje") ||
          texto.includes("estad√≠stica")
        ) {
          slide.needs.chart = true;
        }

        // Regla 2: im√°genes
        if (
          titulo.includes("introducci√≥n") ||
          titulo.includes("contexto") ||
          titulo.includes("visi√≥n") ||
          titulo.includes("futuro") ||
          titulo.includes("conclusi√≥n")
        ) {
          slide.needs.image = true;
        }

        return slide;
      });
        
    let currentLang = "es";

    const textos = {
      es: {
        titulo: "Generador Nova ¬∑ Presentaciones",
        labelTitulo: "T√≠tulo de la presentaci√≥n",
        labelSlides: "N√∫mero de diapositivas",
        labelContenido: "Contenido base (cap√≠tulo, texto o guion)",
        btnGenerar: "Generar estructura de presentaci√≥n",
        btnPPT: "üì§ Exportar a PPT",
        estadoListo: "üü¢ Generador listo",
        estadoProcesando: "‚è≥ Procesando solicitud‚Ä¶",
        errorContenido: "‚ö†Ô∏è Introduce un texto base antes de generar la presentaci√≥n.",
        errorConexion: "‚ùå No se pudo conectar con el servicio.",
        phTitulo: "Ejemplo: Innovaci√≥n y futuro de la colaboraci√≥n humano-IA",
        phContenido: "Pega aqu√≠ tu cap√≠tulo, texto o guion base‚Ä¶"
      },

      en: {
        titulo: "Nova Presentation Generator",
        labelTitulo: "Presentation title",
        labelSlides: "Number of slides",
        labelContenido: "Base content (chapter, text or script)",
        btnGenerar: "Generate presentation structure",
        btnPPT: "üì§ Export to PPT",
        estadoListo: "üü¢ Generator ready",
        estadoProcesando: "‚è≥ Processing request‚Ä¶",
        errorContenido: "‚ö†Ô∏è Please enter base content before generating.",
        errorConexion: "‚ùå Could not connect to the service.",
        phTitulo: "Example: Innovation and the future of human-AI collaboration",
        phContenido: "Paste your chapter, text, or script here‚Ä¶"
      },

      ja: {
        titulo: "Nova „Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥ÁîüÊàêÂô®",
        labelTitulo: "„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„ÅÆ„Çø„Ç§„Éà„É´",
        labelSlides: "„Çπ„É©„Ç§„ÉâÊï∞",
        labelContenido: "„Éô„Éº„ÇπÂÜÖÂÆπÔºàÁ´†„Éª„ÉÜ„Ç≠„Çπ„Éà„ÉªÂè∞Êú¨Ôºâ",
        btnGenerar: "„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥ÊßãÊàê„ÇíÁîüÊàê",
        btnPPT: "üì§ PPT„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
        estadoListo: "üü¢ Ê∫ñÂÇôÂÆå‰∫Ü",
        estadoProcesando: "‚è≥ Âá¶ÁêÜ‰∏≠‚Ä¶",
        errorContenido: "‚ö†Ô∏è ÁîüÊàê„Åô„ÇãÂâç„Å´ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        errorConexion: "‚ùå „Çµ„Éº„Éì„Çπ„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
        phTitulo: "‰æãÔºö‰∫∫Èñì„Å®AI„ÅÆÂçîÂÉç„ÅÆÈù©Êñ∞„Å®Êú™Êù•",
        phContenido: "„Åì„Åì„Å´Á´†„ÉªÊú¨Êñá„ÉªÂè∞Êú¨„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ‚Ä¶"
      }
    };
   
function setLanguage(lang) { 
    const t = textos[lang] || textos.es;

    currentLang = lang;
    localStorage.setItem("nova_lang", lang);

    document.querySelector("h1").innerText = t.titulo;

    document.querySelector("label[for='titulo']").innerText = t.labelTitulo;
    document.querySelector("label[for='slides']").innerText = t.labelSlides;
    document.querySelector("label[for='contenido']").innerText = t.labelContenido;

    document.getElementById("titulo").placeholder = t.phTitulo;
    document.getElementById("contenido").placeholder = t.phContenido;

    document.querySelector("button[onclick='generar()']").innerText = t.btnGenerar;
    document.getElementById("btnPPT").innerText = t.btnPPT;

    document.getElementById("estado").innerText = t.estadoListo;
    }
    
    const API_BASE_URL = "https://programanovabackend-production.up.railway.app";
    // üîπ Inicializaci√≥n final del idioma (√öNICA)
    const savedLang = localStorage.getItem("nova_lang") || "es";
    document.getElementById("langSelector").value = savedLang;    
    setLanguage(savedLang);
    /** Limpia markdown, numeraci√≥n y separa t√≠tulo + bullets */
      function normalizarItem(item) {
        let s = String(item || "").trim();

      // Quitar markdown fuerte **texto**
      s = s.replace(/\*\*/g, "");

      // Quitar numeraci√≥n tipo "1." 
      s = s.replace(/^\s*\d+\.\s*/, "");
    
      // Quitar guiones repetidos tipo "- "
      s = s.replace(/^\s*-\s*/gm, "");

      // Si contiene " - Idea principal:" lo separamos
      let titulo = s;
      let bullets = [];

    const parts = s.split(/\s*-\s*Idea principal:\s*/i);
      if (parts.length > 1) {
          titulo = parts[0].trim();
    const idea = parts.slice(1).join(" - Idea principal: ").trim();
      if (idea) bullets.push(idea);
      }

  // Si el t√≠tulo a√∫n trae ":" tipo "Portada: ..." separamos
  const colon = titulo.split(/\s*:\s*/);
      if (colon.length > 1) {
          titulo = colon[0].trim();
  const resto = colon.slice(1).join(": ").trim();
      if (resto) bullets.push(resto);
      }

  // Si hay l√≠neas m√∫ltiples, primera = t√≠tulo y el resto bullets
  const lines = titulo.split("\n").map(l => l.trim()).filter(Boolean);
  if (lines.length > 1) {
    titulo = lines[0];
    bullets = bullets.concat(lines.slice(1));
  }

  // Quitar frases no deseadas si vienen mezcladas
  const basura = [
    "Aqu√≠ tienes la estructura de la presentaci√≥n",
    "Estructura generada",
    "Presentaci√≥n generada correctamente"
  ];
  if (basura.some(b => titulo.toLowerCase().includes(b.toLowerCase()))) {
    // Si detectamos basura, intentamos quedarnos con algo √∫til
    // (si no hay, devolvemos vac√≠o)
    titulo = titulo.replace(/Aqu√≠ tienes.*?:/i, "").trim();
  }

  return { titulo: titulo.trim(), bullets: bullets.map(b => b.trim()).filter(Boolean) };
}

/** Construye estructura limpia (array de {titulo, bullets}) */
function construirEstructuraLimpia(arr) {
  const out = [];
  for (const it of (arr || [])) {
    const obj = normalizarItem(it);
    if (!obj.titulo) continue;
    out.push(obj);
  }
  return out;
}

function agruparEnSlides(items) {
  const basura = [
    "aqu√≠ tienes la estructura",
    "estructura generada",
    "presentaci√≥n generada correctamente",
    "esta estructura proporciona",
    "flujo l√≥gico"
  ];

  const esBasura = (t) => basura.some(b => (t || "").toLowerCase().includes(b));

  const pareceTitulo = (t) => {
    const s = (t || "").trim();
    if (!s) return false;
    if (esBasura(s)) return false;

    // Heur√≠stica: si empieza por verbo/una frase larga, suele ser bullet
    const long = s.length > 60;
    const endsDot = s.endsWith(".");
    const startsLower = /^[a-z√°√©√≠√≥√∫√±]/.test(s);

    // Si es muy largo, o acaba en punto, o empieza en min√∫scula ‚Üí probablemente bullet
    if (long || endsDot || startsLower) return false;

    // Si contiene ":" suele ser t√≠tulo
    if (s.includes(":")) return true;

    // Si son pocas palabras ‚Üí t√≠tulo
    if (s.split(/\s+/).length <= 6) return true;

    return true;
  };

  const slides = [];
  let current = null;

  for (const it of items) {
    const text = (it.titulo || "").trim();
    if (!text || esBasura(text)) continue;

    if (pareceTitulo(text)) {
      current = { titulo: text, bullets: [] };
      slides.push(current);
      // si el item original ya tra√≠a bullets, los a√±adimos
      if (Array.isArray(it.bullets) && it.bullets.length) {
        current.bullets.push(...it.bullets);
      }
    } else {
      // bullet: si no hay t√≠tulo a√∫n, creamos uno gen√©rico
      if (!current) {
        current = { titulo: "Introducci√≥n", bullets: [] };
        slides.push(current);
      }
      current.bullets.push(text);
      if (Array.isArray(it.bullets) && it.bullets.length) {
        current.bullets.push(...it.bullets);
      }
    }
  }

  return slides;
}
         
  estadoEl.innerText = t.estadoProcesando;
  resultadoEl.innerHTML = "";

  try {
    const response = await fetch(`${API_BASE_URL}/generar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ titulo, num_diapositivas: numDiapositivas, contenido }),
      mode: "cors",
    });

    if (!response.ok) {
      estadoEl.innerText = t.errorConexion;
      return;
    }

    const data = await response.json().catch(() => ({}));
    estadoEl.innerText = data.mensaje || "‚úÖ Estructura generada correctamente.";

    if (Array.isArray(data.estructura)) {
      estructuraGenerada = data.estructura;
      ultimaEstructuraLimpia = agruparEnSlides(construirEstructuraLimpia(data.estructura));
      planPro = construirPlanPro(ultimaEstructuraLimpia);
      planPro = aplicarReglasPro(planPro);
      console.log("PLAN PRO:", planPro);
      renderPlanPro(planPro);

function renderPlanPro(plan) {
  const resultadoEl = document.getElementById("resultado");

    
  resultadoEl.innerHTML += `
    <hr style="margin:24px 0; border-color:#334155;">
    <h3 style="color:#38bdf8;">üß† Plan NOVA PRO (Fase 2)</h3>
    <ul>
      ${plan.map((slide, i) => `
        <li style="margin-bottom:12px;">
          <b>Diapositiva ${i + 1}:</b> ${slide.title}<br>
          üñº Imagen: ${slide.needsImage ? "S√≠" : "No"}<br>
          üìä Gr√°fico: ${slide.needsChart ? "S√≠" : "No"}<br>
          üé® Tema: ${slide.theme.mode}
        </li>
      `).join("")}
    </ul>
  `;
      document.getElementById("btnPPT").disabled = false;
      document.getElementById("btnPPT2").disabled = false;   
}  

// ====== Render normal (estructura generada) ======
const listaHTML = (ultimaEstructuraLimpia || []).map((obj, i) => {
  const bullets = (obj.bullets && obj.bullets.length)
    ? `<ul>${obj.bullets.map(b => `<li>${b}</li>`).join("")}</ul>`
    : "";

  return `<li><b>${i + 1}. ${obj.titulo}</b>${bullets}</li>`;
}).join("");

resultadoEl.innerHTML = `
  <h3>Estructura generada</h3>
  <ul>
    ${listaHTML}
  </ul>
`;
      } 
        
function exportarPPT() {
  // 1) Seguridad: hay estructura?
  if (!Array.isArray(ultimaEstructuraLimpia) || ultimaEstructuraLimpia.length === 0) {
    alert("Primero genera una presentaci√≥n.");
    return;
  }

  // 2) Seguridad: librer√≠a cargada?
  if (typeof PptxGenJS === "undefined") {
    console.error("PptxGenJS no est√° cargado.");
    alert("No se ha cargado la librer√≠a de PowerPoint. Recarga la p√°gina e int√©ntalo de nuevo.");
    return;
  }

  // 3) Nombre de archivo
  const titulo = (document.getElementById("titulo").value || "Nova_Presentacion").trim();
  const safeTitle = titulo.replace(/[^\w\-]+/g, "_").slice(0, 40) || "Nova_Presentacion";
  const fileName = `${safeTitle}_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-")}.pptx`;

  const pptx = new PptxGenJS();

  // 4) Regla: "Idea principal" NO crea slide; alimenta el t√≠tulo anterior
  const esIdeaPrincipal = (t) => /^idea principal$/i.test((t || "").trim());
  const esBasura = (t) => {
    const s = (t || "").toLowerCase();
    return (
      s.includes("aqu√≠ tienes la estructura") ||
      s.includes("estructura generada") ||
      s.includes("presentaci√≥n generada correctamente")
    );
  };

  for (let i = 0; i < ultimaEstructuraLimpia.length; i++) {
    const actual = ultimaEstructuraLimpia[i];
    if (!actual || !actual.titulo) continue;

    const tituloSlide = actual.titulo.trim();

    // Saltar basura y saltar "Idea principal" como slide
    if (esBasura(tituloSlide) || esIdeaPrincipal(tituloSlide)) continue;

    const slide = pptx.addSlide();

    // T√≠tulo
    slide.addText(tituloSlide, {
      x: 0.5,
      y: 0.5,
      w: 9,
      h: 0.8,
      fontSize: 22,
      bold: true,
    });

    // Contenido: si el siguiente item es "Idea principal", usar sus bullets
    const siguiente = ultimaEstructuraLimpia[i + 1];
    let bullets = [];

    if (siguiente && esIdeaPrincipal(siguiente.titulo)) {
      bullets = Array.isArray(siguiente.bullets) ? siguiente.bullets : [];
      i++; // consumimos el siguiente
    } else {
      bullets = Array.isArray(actual.bullets) ? actual.bullets : [];
    }

    if (bullets.length) {
      slide.addText(bullets.map(b => `- ${b}`).join("\n"), {
        x: 0.7,
        y: 1.5,
        w: 9,
        h: 4.5,
        fontSize: 16,
        wrap: true,
      });
    } else {
      slide.addText("- Idea principal", {
        x: 0.7,
        y: 1.5,
        w: 9,
        h: 1.0,
        fontSize: 16,
        wrap: true,
      });
    }
  }

  // 5) Export
  pptx.writeFile({ fileName });
}
      
async function generar() {
  const tituloEl = document.getElementById("titulo");
  const slidesEl = document.getElementById("slides");
  const contenidoEl = document.getElementById("contenido");
  const estadoEl = document.getElementById("estado");
  const resultadoEl = document.getElementById("resultado");

  const t = textos[currentLang] || textos.es;
    
  const titulo = (tituloEl.value || "").trim();
  const numDiapositivas = slidesEl.value;
  const contenido = (contenidoEl.value || "").trim();

  if (!contenido) {
    estadoEl.innerText = "‚ö†Ô∏è Introduce un texto base antes de generar.";
    return;
  }

  estadoEl.innerText = "‚è≥ Procesando solicitud‚Ä¶";
  resultadoEl.innerHTML = "";

  try {
    const response = await fetch(`${API_BASE_URL}/generar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        titulo,
        num_diapositivas: numDiapositivas,
        contenido
      }),
      mode: "cors",
    });

    if (!response.ok) {
      estadoEl.innerText = "‚ùå Error de conexi√≥n";
      return;
    }

    const data = await response.json();
    estadoEl.innerText = data.mensaje || "‚úÖ Estructura generada correctamente.";

    if (Array.isArray(data.estructura)) {
      estructuraGenerada = data.estructura;
      ultimaEstructuraLimpia = agruparEnSlides(
        construirEstructuraLimpia(data.estructura)
      );
      // üîπ FASE 2 PRO
      let planPro = construirPlanPro(ultimaEstructuraLimpia);
      planPro = aplicarReglasPro(planPro);
      renderPlanPro(planPro);
       
      document.getElementById("btnPPT").disabled = false;
      document.getElementById("btnPPT2").disabled = false;
    }
  } catch (err) {
    console.error(err);
    estadoEl.innerText = "‚ùå No se pudo conectar con el servicio.";
  }
}
    
</script>
</body>
</html>
